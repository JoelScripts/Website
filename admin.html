<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ†Ô∏è Admin ‚Äî Schedule</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 2rem; }
    .admin-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.8rem; padding: 1.5rem; }
    .admin-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .admin-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .admin-row > div { display: flex; flex-direction: column; gap: 0.4rem; }
    .admin-card label { color: #e0e0e0; font-weight: 600; }
    .admin-card input, .admin-card textarea, .admin-card select {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .admin-card textarea { min-height: 360px; resize: vertical; }
    .schedule-grid { display: grid; grid-template-columns: 1fr; gap: 1.05rem; }

    /* Mobile-friendly day cards */
    .schedule-day {
      border-radius: 0.8rem;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .schedule-day summary {
      cursor: pointer;
      list-style: none;
      padding: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      user-select: none;
    }
    .schedule-day summary::-webkit-details-marker { display: none; }
    .schedule-day .summary-left { display: flex; flex-direction: column; gap: 0.2rem; min-width: 0; }
    .schedule-day .summary-top { display: flex; align-items: baseline; gap: 0.6rem; flex-wrap: wrap; }
    .schedule-day .summary-day { font-weight: 900; letter-spacing: 0.6px; }
    .schedule-day .summary-date { color: var(--text-muted); font-weight: 800; }
    .schedule-day .summary-sub {
      display: flex;
      gap: 0.6rem;
      color: var(--text-muted);
      font-size: 0.88rem;
      line-height: 1.2;
      min-width: 0;
      flex-wrap: wrap;
    }
    .schedule-day .summary-time { white-space: nowrap; }
    .schedule-day .summary-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 42ch; }
    .schedule-day .summary-right { display: flex; align-items: center; gap: 0.6rem; }
    .schedule-day .chev { color: var(--text-muted); font-weight: 900; transform: rotate(0deg); transition: transform 120ms ease; }
    .schedule-day[open] .chev { transform: rotate(90deg); }

    .schedule-day .status-pill {
      font-size: 0.72rem;
      font-weight: 900;
      letter-spacing: 0.7px;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      text-transform: uppercase;
      white-space: nowrap;
    }
    .schedule-day .status-pill.none { display: none; }
    .schedule-day .status-pill.scheduled { border-color: rgba(255, 140, 66, 0.5); background: rgba(255, 140, 66, 0.12); color: #FFB88A; }
    .schedule-day .status-pill.delayed { border-color: rgba(255, 183, 77, 0.65); background: rgba(255, 183, 77, 0.16); color: #FFD9A6; }
    .schedule-day .status-pill.cancelled { border-color: rgba(255, 68, 68, 0.6); background: rgba(255, 68, 68, 0.14); color: #ff9a9a; }
    .schedule-day .status-pill.completed { border-color: rgba(76, 175, 80, 0.55); background: rgba(76, 175, 80, 0.14); color: #9BE7A0; }

    .schedule-item {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 0.9rem;
      align-items: start;
      padding: 0.9rem;
    }
    .schedule-item .field { min-width: 0; }
    .schedule-item .field-day { grid-column: 1 / span 2; }
    .schedule-item .field-date { grid-column: 3 / span 3; }
    .schedule-item .field-time { grid-column: 6 / span 2; }
    .schedule-item .field-title { grid-column: 8 / span 3; }
    .schedule-item .field-status { grid-column: 11 / span 2; }
    /* Default placement for delayed field (when visible) */
    .schedule-item .field-delayed { grid-column: 8 / span 3; }
    /* When delayed is active, move Title to its own line for breathing room */
    .schedule-item.is-delayed .field-time { grid-column: 6 / span 2; }
    .schedule-item.is-delayed .field-delayed { grid-column: 8 / span 3; }
    .schedule-item.is-delayed .field-status { grid-column: 11 / span 2; }
    .schedule-item.is-delayed .field-title { grid-column: 1 / span 12; }
    .schedule-item .field { display: flex; flex-direction: column; gap: 0.35rem; }
    .schedule-item .field small { color: var(--text-muted); }
    .schedule-item .toggle {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.65rem 0.9rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #fff;
      user-select: none;
    }
    .schedule-item input[type="checkbox"] { width: 18px; height: 18px; padding: 0; }
    .schedule-header-row {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 0.7rem;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 0.85rem;
      padding: 0 0.2rem;
    }
    .schedule-header-row > div:nth-child(1) { grid-column: 1 / span 2; }
    .schedule-header-row > div:nth-child(2) { grid-column: 3 / span 3; }
    .schedule-header-row > div:nth-child(3) { grid-column: 6 / span 2; }
    .schedule-header-row > div:nth-child(4) { grid-column: 8 / span 3; }
    .schedule-header-row > div:nth-child(5) { grid-column: 11 / span 2; }
    .advanced {
      margin-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 1rem;
    }
    .advanced details { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.8rem; padding: 0.9rem; }
    .advanced summary { cursor: pointer; color: #e0e0e0; font-weight: 700; }
    .admin-actions { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
    .admin-actions .spacer { flex: 1; }
    .admin-actions button {
      background: var(--primary);
      border: none;
      color: #fff;
      padding: 0.7rem 1.1rem;
      border-radius: 0.6rem;
      cursor: pointer;
      font-weight: 700;
    }
    .admin-actions button.secondary { background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.18); }
    .admin-actions button.danger { background: rgba(255, 90, 90, 0.20); border: 1px solid rgba(255, 90, 90, 0.35); }
    .admin-msg { color: var(--text-muted); }
    .admin-msg.ok { color: #66BB6A; }
    .admin-msg.err { color: #ff6666; }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    .hidden { display: none !important; }
    @media (max-width: 980px) {
      /* Wide phones/tablets: clean 2-col layout + full-width Status */
      .admin-row { grid-template-columns: 1fr; }
      .schedule-header-row { display: none; }

      .admin-wrap { padding: 1.2rem; }
      .admin-card { padding: 1.1rem; }

      .schedule-item {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.85rem;
        padding: 1rem;
        align-items: start;
      }

      .schedule-item .field-day { grid-column: 1; }
      .schedule-item .field-date { grid-column: 2; }
      .schedule-item .field-time { grid-column: 1; }
      .schedule-item .field-title { grid-column: 2; }

      .schedule-item .field.field-status { grid-column: 1 / -1; }
      .schedule-item .field.field-delayed { grid-column: 1 / -1; }

      /* Delayed/completed can have extra inputs; give them room */
      .schedule-item.is-delayed { grid-template-columns: 1fr; }
      .schedule-item.is-delayed .field-day,
      .schedule-item.is-delayed .field-date,
      .schedule-item.is-delayed .field-time,
      .schedule-item.is-delayed .field-delayed,
      .schedule-item.is-delayed .field-title,
      .schedule-item.is-delayed .field-status { grid-column: 1 / -1; }
    }

    @media (max-width: 520px) {
      /* Small phones: single column */
      .schedule-item { grid-template-columns: 1fr; align-items: start; }
      .schedule-item .field-day,
      .schedule-item .field-date,
      .schedule-item .field-time,
      .schedule-item .field-title,
      .schedule-item .field-status,
      .schedule-item .field-delayed { grid-column: 1 / -1; }
      .schedule-day .summary-title { max-width: 26ch; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">flywithjoel</div>
      <ul class="nav-links" style="display:flex; gap: 1rem;">
        <li><a href="/">Home</a></li>
      </ul>
    </div>
  </nav>

  <main class="admin-wrap">
    <h1 style="margin-top: 1rem;">üõ†Ô∏è Schedule Admin</h1>

    <p class="muted">üîê Sign in to edit the schedule. This page saves to <code>/api/schedule</code> (Cloudflare Worker + KV).</p>

    <div id="status-bar" class="admin-msg" style="margin: 0.75rem 0 0;"></div>

    <div id="login-card" class="admin-card">
      <div class="admin-grid">
        <h2 style="margin: 0;">üîë Admin Login</h2>
        <p class="admin-msg" style="margin-top: -0.2rem;">Enter your Worker username/password to unlock editing.</p>

        <div class="admin-row">
          <div>
            <label for="admin-user">Username</label>
            <input id="admin-user" type="text" autocomplete="username" />
          </div>
          <div>
            <label for="admin-pass">Password</label>
            <input id="admin-pass" type="password" autocomplete="current-password" />
          </div>
        </div>

        <div class="admin-actions">
          <button id="btn-unlock" type="button">üîì Unlock</button>
          <span id="status" class="admin-msg"></span>
        </div>
      </div>
    </div>

    <div id="editor-card" class="admin-card hidden" style="margin-top: 1rem;">
      <div class="admin-grid">
        <div style="display:flex; align-items: baseline; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
          <div>
            <h2 style="margin: 0;">üìÖ 7 Day Schedule</h2>
            <p class="admin-msg" style="margin-top: 0.2rem;">Edit each day: month/day, time (Zulu), and whether there is a stream.</p>
          </div>
          <div id="signed-in-pill" class="muted">You‚Äôre signed in.</div>
        </div>

        <div>
          <div class="schedule-header-row" aria-hidden="true">
            <div>Day</div>
            <div>Date</div>
            <div>Time</div>
            <div>Title</div>
            <div>Stream?</div>
          </div>
          <div id="schedule-grid" class="schedule-grid"></div>

          <div class="advanced">
            <details>
              <summary>üß™ Advanced (raw JSON)</summary>
              <p class="admin-msg">Optional. This is what gets saved to the API.</p>
              <textarea id="schedule-json" spellcheck="false"></textarea>
            </details>
          </div>
        </div>

        <div class="admin-actions">
          <button id="btn-load" class="secondary" type="button">üîÑ Load current</button>
          <button id="btn-format" class="secondary" type="button">üß© Sync JSON</button>
          <button id="btn-save" type="button">üíæ Save schedule</button>
          <span class="spacer"></span>
          <button id="btn-lock" class="danger" type="button">üîí Lock</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const statusBarEl = document.getElementById('status-bar');
    const userEl = document.getElementById('admin-user');
    const passEl = document.getElementById('admin-pass');
    const jsonEl = document.getElementById('schedule-json');
    const scheduleGridEl = document.getElementById('schedule-grid');
    const loginCardEl = document.getElementById('login-card');
    const editorCardEl = document.getElementById('editor-card');
    const signedInPillEl = document.getElementById('signed-in-pill');

    const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const DEFAULT_DAYS = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

    const STATUSES = [
      { value: 'none', label: 'üö´ No stream' },
      { value: 'scheduled', label: 'üóìÔ∏è Scheduled' },
      { value: 'cancelled', label: '‚ùå Cancelled' },
      { value: 'delayed', label: '‚è≥ Delayed' },
      { value: 'completed', label: '‚úÖ Completed' },
    ];

    const SCHEDULE_API_LOCALSTORAGE_KEY = 'fwj_schedule_api';

    function sanitizeApiUrl(raw) {
      const s = (raw || '').trim();
      if (!s) return null;
      // Allow absolute http(s) or same-origin relative paths.
      if (/^https?:\/\//i.test(s)) return s.replace(/\s+/g, '');
      if (s.startsWith('/')) return s;
      return null;
    }

    function getScheduleApiOverride() {
      // Query param wins and is persisted.
      try {
        const params = new URLSearchParams(window.location.search);
        const qp = sanitizeApiUrl(params.get('scheduleApi'));
        if (qp) {
          localStorage.setItem(SCHEDULE_API_LOCALSTORAGE_KEY, qp);
          return qp;
        }
      } catch {
        // ignore
      }

      try {
        const fromLs = sanitizeApiUrl(localStorage.getItem(SCHEDULE_API_LOCALSTORAGE_KEY));
        if (fromLs) return fromLs;
      } catch {
        // ignore
      }

      // Optional meta override.
      const meta = document.querySelector('meta[name="schedule-api"]');
      const metaVal = sanitizeApiUrl(meta ? meta.getAttribute('content') : '');
      return metaVal;
    }

    function getScheduleApiCandidates() {
      const override = getScheduleApiOverride();
      const candidates = [
        override,
        '/api/schedule',
        'https://api.flyingwithjoel.co.uk/api/schedule.php',
      ].filter(Boolean);

      // De-dupe
      return Array.from(new Set(candidates));
    }

    let authHeader = null;

    function isPreviewMode() {
      try {
        return new URLSearchParams(window.location.search).get('preview') === '1';
      } catch {
        return false;
      }
    }

    async function fetchFirstOkJson(urls, init) {
      for (const u of urls) {
        try {
          const resp = await fetch(u, init);
          if (!resp.ok) continue;
          return { url: u, data: await resp.json() };
        } catch {
          // try next
        }
      }
      return null;
    }

    function monthOptionsHtml(selectedIndex) {
      return MONTHS.map((m, idx) => `<option value="${idx + 1}" ${idx === selectedIndex ? 'selected' : ''}>${m}</option>`).join('');
    }

    function statusOptionsHtml(selectedValue) {
      const v = (selectedValue || 'none').toLowerCase();
      return STATUSES.map((s) => `<option value="${s.value}" ${s.value === v ? 'selected' : ''}>${s.label}</option>`).join('');
    }

    function buildEmptySchedule() {
      const today = new Date();
      const month = today.getMonth() + 1;
      const day = today.getDate();

      const items = [];
      for (let i = 0; i < 7; i += 1) {
        items.push({
          dateKey: `${month}-${day}`,
          dayName: DEFAULT_DAYS[i] || '-',
          dateText: `${MONTHS[month - 1]} ${day}`,
          status: 'none',
          gameLogo: '-',
          timeText: 'No Stream Planned',
          zuluTime: null,
          streamTitle: '-',
          vodUrl: null,
        });
      }
      return items;
    }

    function parseDateKey(dateKey) {
      const m = typeof dateKey === 'string' ? dateKey.match(/^(\d{1,2})-(\d{1,2})$/) : null;
      if (!m) return { month: 1, day: 1 };
      return { month: Math.max(1, Math.min(12, parseInt(m[1], 10))), day: Math.max(1, Math.min(31, parseInt(m[2], 10))) };
    }

    function renderEditor(items) {
      scheduleGridEl.innerHTML = '';

      items.slice(0, 7).forEach((item, idx) => {
        const parsed = parseDateKey(item.dateKey);
        const monthIdx = parsed.month - 1;
        const status = (item && item.status ? String(item.status) : 'none').toLowerCase();
        const originalZulu = (item && item.originalZuluTime ? String(item.originalZuluTime) : '');
        const zuluForTimeField = status === 'delayed' ? originalZulu : (item && item.zuluTime ? String(item.zuluTime) : '');
        const zuluForDelayedTo = status === 'delayed' ? (item && item.zuluTime ? String(item.zuluTime) : '') : '';
        const vodUrl = (item && item.vodUrl ? String(item.vodUrl) : '');

        const wrapper = document.createElement('details');
        wrapper.className = 'schedule-day';

        const summary = document.createElement('summary');
        summary.innerHTML = `
          <div class="summary-left">
            <div class="summary-top">
              <span class="summary-day"></span>
              <span class="summary-date"></span>
            </div>
            <div class="summary-sub">
              <span class="summary-time"></span>
              <span class="summary-title"></span>
            </div>
          </div>
          <div class="summary-right">
            <span class="status-pill"></span>
            <span class="chev">‚Ä∫</span>
          </div>
        `;

        const row = document.createElement('div');
        row.className = 'schedule-item';
        row.dataset.index = String(idx);

        row.innerHTML = `
          <div class="field field-day">
            <label>Day</label>
            <input type="text" class="dayName" value="${(item.dayName || DEFAULT_DAYS[idx] || '').replace(/"/g,'&quot;')}" maxlength="5" />
          </div>

          <div class="field field-date">
            <label>Date</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
              <select class="month">${monthOptionsHtml(monthIdx)}</select>
              <input type="number" class="day" min="1" max="31" value="${parsed.day}" />
            </div>
            <small class="datePreview"></small>
          </div>

          <div class="field field-time">
            <label>Time (Zulu)</label>
            <input type="text" class="time" placeholder="18:00 Zulu" value="${(zuluForTimeField || '').replace(/"/g,'&quot;')}" />
          </div>

          <div class="field field-delayed delayedWrap">
            <label>New Time (Zulu)</label>
            <input type="text" class="delayedTo" placeholder="19:30 Zulu" value="${(zuluForDelayedTo || '').replace(/"/g,'&quot;')}" />
            <small class="delayedHint"></small>
          </div>

          <div class="field field-title">
            <label>Title</label>
            <input type="text" class="title" placeholder="Microsoft Flight Simulator" value="${(item.streamTitle || '').replace(/"/g,'&quot;')}" />

            <div class="vodWrap" style="margin-top: 0.6rem;">
              <label style="font-size: 0.85rem; font-weight: 700;">Twitch VOD link (optional)</label>
              <input type="url" class="vodUrl" placeholder="https://www.twitch.tv/videos/..." value="${(vodUrl || '').replace(/"/g,'&quot;')}" />
              <small class="vodHint"></small>
            </div>
          </div>

          <div class="field field-status">
            <label>Status</label>
            <select class="status">${statusOptionsHtml(status)}</select>
            <small class="streamHint"></small>
          </div>
        `;

        wrapper.appendChild(summary);
        wrapper.appendChild(row);
        scheduleGridEl.appendChild(wrapper);

        // Initialize previews
        updateRowDerived(row);

        // Initialize summary
        updateSummary(wrapper, row);

        // Wire changes
        row.querySelectorAll('input, select').forEach((el) => {
          el.addEventListener('input', () => {
            updateRowDerived(row);
            updateSummary(wrapper, row);
            syncJsonFromEditor(false);
          });
          el.addEventListener('change', () => {
            updateRowDerived(row);
            updateSummary(wrapper, row);
            syncJsonFromEditor(false);
          });
        });
      });

      // Ensure JSON reflects UI
      syncJsonFromEditor(true);

      // Desktop: expand all cards for faster editing
      setDetailsOpenByViewport();
    }

    function statusLabel(status) {
      const s = (status || 'none').toLowerCase();
      if (s === 'scheduled') return 'scheduled';
      if (s === 'cancelled') return 'cancelled';
      if (s === 'delayed') return 'delayed';
      if (s === 'completed') return 'completed';
      return 'none';
    }

    function statusEmoji(status) {
      const s = (status || 'none').toLowerCase();
      if (s === 'scheduled') return 'üóìÔ∏è';
      if (s === 'cancelled') return '‚ùå';
      if (s === 'delayed') return '‚è≥';
      if (s === 'completed') return '‚úÖ';
      return 'üö´';
    }

    function updateSummary(wrapper, row) {
      const day = (row.querySelector('.dayName')?.value || '').trim() || (DEFAULT_DAYS[parseInt(row.dataset.index || '0', 10)] || '-');

      const month = parseInt(row.querySelector('.month')?.value || '1', 10);
      const dayNum = parseInt(row.querySelector('.day')?.value || '1', 10);
      const mIdx = Math.max(1, Math.min(12, month)) - 1;
      const d = Math.max(1, Math.min(31, Number.isFinite(dayNum) ? dayNum : 1));
      const dateText = `${MONTHS[mIdx]} ${d}`;

      const status = statusLabel(row.querySelector('.status')?.value || 'none');

      const title = (row.querySelector('.title')?.value || '').trim() || '‚Äî';
      const time = (row.querySelector('.time')?.value || '').trim();
      const delayedTo = (row.querySelector('.delayedTo')?.value || '').trim();

      const dayEl = wrapper.querySelector('.summary-day');
      const dateEl = wrapper.querySelector('.summary-date');
      const pill = wrapper.querySelector('.status-pill');
      const timeEl = wrapper.querySelector('.summary-time');
      const titleEl = wrapper.querySelector('.summary-title');

      if (dayEl) dayEl.textContent = day;
      if (dateEl) dateEl.textContent = dateText;

      if (timeEl) {
        if (status === 'none') {
          timeEl.textContent = 'üö´ No stream';
        } else if (status === 'delayed') {
          const from = time ? (time.toLowerCase().includes('zulu') ? time : `${time} Zulu`) : 'TBC';
          const to = delayedTo ? (delayedTo.toLowerCase().includes('zulu') ? delayedTo : `${delayedTo} Zulu`) : 'TBC';
          timeEl.textContent = `‚è∞ ${from} ‚Üí ${to}`;
        } else {
          const t = time ? (time.toLowerCase().includes('zulu') ? time : `${time} Zulu`) : 'TBC';
          timeEl.textContent = `‚è∞ ${t}`;
        }
      }

      if (titleEl) {
        titleEl.textContent = status === 'none' ? '' : `üéÆ ${title}`;
      }

      if (pill) {
        pill.className = `status-pill ${status}`;
        pill.textContent = status === 'none' ? '' : `${statusEmoji(status)} ${status}`;
      }
    }

    function setDetailsOpenByViewport() {
      // Only auto-expand on desktop. Wide phones should stay collapsed.
      const shouldOpen = DETAILS_DESKTOP_MQL ? DETAILS_DESKTOP_MQL.matches : false;
      if (lastDetailsAutoOpen === shouldOpen) return;
      lastDetailsAutoOpen = shouldOpen;
      document.querySelectorAll('.schedule-day').forEach((d) => {
        d.open = shouldOpen;
      });
    }

    // Use a media-query listener instead of window resize.
    // Mobile browsers can fire resize events while scrolling (URL bar show/hide), which can cause scroll jumps.
    const DETAILS_DESKTOP_MQL = window.matchMedia ? window.matchMedia('(min-width: 981px)') : null;
    let lastDetailsAutoOpen = null;

    function updateRowDerived(row) {
      const month = parseInt(row.querySelector('.month').value, 10);
      const day = parseInt(row.querySelector('.day').value, 10);
      const previewEl = row.querySelector('.datePreview');

      const mIdx = Math.max(1, Math.min(12, month)) - 1;
      const d = Math.max(1, Math.min(31, Number.isFinite(day) ? day : 1));

      previewEl.textContent = `${MONTHS[mIdx]} ${d}`;

      const status = (row.querySelector('.status').value || 'none').toLowerCase();
      const hintEl = row.querySelector('.streamHint');

      const timeEl = row.querySelector('.time');
      const titleEl = row.querySelector('.title');
      const delayedWrap = row.querySelector('.delayedWrap');
      const delayedToEl = row.querySelector('.delayedTo');
      const delayedHintEl = row.querySelector('.delayedHint');

      const vodWrap = row.querySelector('.vodWrap');
      const vodUrlEl = row.querySelector('.vodUrl');
      const vodHintEl = row.querySelector('.vodHint');

      const isNone = status === 'none';
      const isDelayed = status === 'delayed';
      const isCompleted = status === 'completed';

      row.classList.toggle('is-delayed', isDelayed);

      hintEl.textContent = isNone ? 'No stream planned' : `Status: ${status}`;

      // Show/hide delayed UI
      delayedWrap.style.display = isDelayed ? '' : 'none';
      delayedToEl.disabled = !isDelayed;
      delayedHintEl.textContent = isDelayed ? 'Enter the delayed (new) start time' : '';

      // Show/hide VOD UI (only meaningful for completed)
      vodWrap.style.display = isCompleted ? '' : 'none';
      vodUrlEl.disabled = !isCompleted;
      vodHintEl.textContent = isCompleted ? 'This will appear on the completed card on the homepage.' : '';

      // UX: disable time/title when no stream
      timeEl.disabled = isNone;
      titleEl.disabled = isNone;
      if (isNone) {
        timeEl.value = '';
        titleEl.value = '';
        delayedToEl.value = '';
        vodUrlEl.value = '';
      }
    }

    function scheduleFromEditor() {
      const rows = Array.from(scheduleGridEl.querySelectorAll('.schedule-item'));
      return rows.map((row, idx) => {
        const dayName = (row.querySelector('.dayName').value || DEFAULT_DAYS[idx] || '-').trim();
        const month = Math.max(1, Math.min(12, parseInt(row.querySelector('.month').value, 10)));
        const day = Math.max(1, Math.min(31, parseInt(row.querySelector('.day').value, 10)));
        const dateKey = `${month}-${day}`;
        const dateText = `${MONTHS[month - 1]} ${day}`;

        const status = (row.querySelector('.status').value || 'none').toLowerCase();
        const zuluTimeRaw = (row.querySelector('.time').value || '').trim();
        const delayedToRaw = (row.querySelector('.delayedTo').value || '').trim();
        const titleRaw = (row.querySelector('.title').value || '').trim();
        const vodUrlRaw = (row.querySelector('.vodUrl')?.value || '').trim();

        if (status === 'none') {
          return {
            dateKey,
            dayName,
            dateText,
            status: 'none',
            gameLogo: '-',
            timeText: 'No Stream Planned',
            zuluTime: null,
            streamTitle: '-',
            vodUrl: null,
          };
        }

        const normalizeZulu = (raw) => {
          const r = (raw || '').trim();
          if (!r) return '';
          return r.toLowerCase().includes('zulu') ? r : `${r} Zulu`;
        };

        const streamTitle = titleRaw || 'Stream';

        if (status === 'completed') {
          const zuluTime = normalizeZulu(zuluTimeRaw);
          const timeText = zuluTime || 'Completed';
          const vodUrl = vodUrlRaw || null;

          return {
            dateKey,
            dayName,
            dateText,
            status: 'completed',
            gameLogo: '‚úàÔ∏è',
            timeText,
            zuluTime: zuluTime || null,
            streamTitle,
            vodUrl,
          };
        }

        if (status === 'delayed') {
          const originalZuluTime = normalizeZulu(zuluTimeRaw);
          const delayedZuluTime = normalizeZulu(delayedToRaw);
          const timeText = delayedZuluTime ? `Delayed to ${delayedZuluTime}` : 'Delayed (new time TBC)';

          return {
            dateKey,
            dayName,
            dateText,
            status: 'delayed',
            gameLogo: '‚úàÔ∏è',
            timeText,
            zuluTime: delayedZuluTime || null,
            originalZuluTime: originalZuluTime || null,
            streamTitle,
            vodUrl: null,
          };
        }

        const zuluTime = normalizeZulu(zuluTimeRaw);
        const timeText = zuluTime || (status === 'cancelled' ? 'Cancelled' : 'TBC');

        return {
          dateKey,
          dayName,
          dateText,
          status: status === 'cancelled' ? 'cancelled' : 'scheduled',
          gameLogo: '‚úàÔ∏è',
          timeText,
          zuluTime: zuluTime || null,
          streamTitle,
          vodUrl: null,
        };
      });
    }

    function syncJsonFromEditor(showStatus) {
      const schedule = scheduleFromEditor();
      jsonEl.value = JSON.stringify(schedule, null, 2);
      if (showStatus) setStatus('Editor synced to JSON.', 'ok');
    }

    function setStatus(text, kind) {
      const cls = 'admin-msg' + (kind ? ` ${kind}` : '');

      if (statusEl) {
        statusEl.textContent = text;
        statusEl.className = cls;
      }
      if (statusBarEl) {
        statusBarEl.textContent = text;
        statusBarEl.className = cls;
      }
    }

    function getAuthHeader() {
      const user = userEl.value || '';
      const pass = passEl.value || '';
      if (!user || !pass) return null;
      return 'Basic ' + btoa(`${user}:${pass}`);
    }

    async function verifyCredentials(auth) {
      // Only supported on the Cloudflare Worker backend.
      const resp = await fetch('/api/schedule/auth', {
        method: 'GET',
        headers: { 'authorization': auth },
        cache: 'no-store',
      });
      if (resp.status === 401) return { ok: false, reason: 'Unauthorized (wrong username/password).' };
      if (!resp.ok) return { ok: false, reason: `Auth check failed (${resp.status}).` };
      return { ok: true };
    }

    function unlockUi() {
      loginCardEl.classList.add('hidden');
      editorCardEl.classList.remove('hidden');
    }

    function lockUi() {
      authHeader = null;
      editorCardEl.classList.add('hidden');
      loginCardEl.classList.remove('hidden');
      setStatus('', null);
    }

    async function unlock() {
      const auth = getAuthHeader();
      if (!auth) {
        setStatus('Enter username + password first.', 'err');
        return;
      }
      setStatus('Checking credentials‚Ä¶');
      try {
        const result = await verifyCredentials(auth);
        if (!result.ok) {
          setStatus(result.reason || 'Login failed.', 'err');
          return;
        }
        authHeader = auth;
        unlockUi();
        setStatus('Unlocked.', 'ok');
        await loadCurrent();
      } catch (e) {
        console.error(e);
        setStatus('Login failed (could not reach auth endpoint).', 'err');
      }
    }

    async function loadCurrent() {
      setStatus('Loading‚Ä¶');
      try {
        const result = await fetchFirstOkJson(getScheduleApiCandidates(), { cache: 'no-store' });
        if (!result) throw new Error('No schedule API responded.');
        const data = result.data;
        const items = Array.isArray(data) ? data : buildEmptySchedule();
        renderEditor(items);
        setStatus(`Loaded from ${result.url}`, 'ok');
      } catch (e) {
        console.error(e);
        renderEditor(buildEmptySchedule());
        setStatus('Failed to load schedule (showing local editor).', 'err');
      }
    }

    function formatJson() {
      syncJsonFromEditor(true);
    }

    async function saveSchedule() {
      if (isPreviewMode()) {
        setStatus('Preview mode: saving is disabled.', 'err');
        return;
      }
      const auth = authHeader;
      if (!auth) {
        setStatus('Locked. Click Unlock first.', 'err');
        return;
      }

      const parsed = scheduleFromEditor();
      jsonEl.value = JSON.stringify(parsed, null, 2);

      setStatus('Saving‚Ä¶');
      try {
        const targets = getScheduleApiCandidates();
        let savedUrl = null;
        let lastStatus = null;
        let lastBody = null;

        for (const u of targets) {
          try {
            const resp = await fetch(u, {
              method: 'PUT',
              headers: {
                'content-type': 'application/json',
                'authorization': auth,
              },
              body: JSON.stringify(parsed),
            });

            lastStatus = resp.status;
            if (resp.status === 401) {
              setStatus('Unauthorized (wrong username/password).', 'err');
              return;
            }

            if (!resp.ok) {
              try { lastBody = await resp.text(); } catch { lastBody = null; }
              continue;
            }
            savedUrl = u;
            break;
          } catch {
            // try next
          }
        }

        if (!savedUrl) {
          const extra = lastBody ? ` ‚Äî ${lastBody.slice(0, 180)}` : '';
          throw new Error(`Save failed (last status: ${lastStatus ?? 'n/a'})${extra}`);
        }

        setStatus(`Saved to ${savedUrl}. Homepage will update once it can fetch the API.`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus(String(e && e.message ? e.message : 'Save failed.'), 'err');
      }
    }

    document.getElementById('btn-unlock').addEventListener('click', unlock);
    document.getElementById('btn-load').addEventListener('click', loadCurrent);
    document.getElementById('btn-format').addEventListener('click', formatJson);
    document.getElementById('btn-save').addEventListener('click', saveSchedule);
    document.getElementById('btn-lock').addEventListener('click', lockUi);

    // Default locked view
    if (isPreviewMode()) {
      authHeader = null;
      loginCardEl.classList.add('hidden');
      editorCardEl.classList.remove('hidden');

      const saveBtn = document.getElementById('btn-save');
      const lockBtn = document.getElementById('btn-lock');
      if (saveBtn) saveBtn.disabled = true;
      if (lockBtn) lockBtn.classList.add('hidden');
      if (signedInPillEl) signedInPillEl.textContent = 'Preview mode (cannot save).';

      setStatus('Preview mode enabled.', 'ok');
      loadCurrent();
    } else {
      lockUi();
    }

    if (DETAILS_DESKTOP_MQL) {
      if (typeof DETAILS_DESKTOP_MQL.addEventListener === 'function') {
        DETAILS_DESKTOP_MQL.addEventListener('change', setDetailsOpenByViewport);
      } else if (typeof DETAILS_DESKTOP_MQL.addListener === 'function') {
        DETAILS_DESKTOP_MQL.addListener(setDetailsOpenByViewport);
      }
    }
  </script>
</body>
</html>
