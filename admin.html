<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ› ï¸ Admin â€” Schedule</title>
  <meta name="robots" content="noindex,nofollow" />
  <script>
    // Top-level utility: normalizeZulu
    function normalizeZulu(raw) {
      const r = (raw || '').trim();
      if (!r) return '';
      return r.toLowerCase().includes('zulu') ? r : `${r} Zulu`;
    }
  </script>
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .admin-wrap { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .admin-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.9rem; padding: 1.5rem; }
    .admin-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .admin-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .admin-row > div { display: flex; flex-direction: column; gap: 0.4rem; }
    .admin-card label { color: #e0e0e0; font-weight: 600; }
    .admin-card input, .admin-card textarea, .admin-card select {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Chrome/Safari autofill can force a light background; keep it dark */
    .admin-card input:-webkit-autofill,
    .admin-card input:-webkit-autofill:hover,
    .admin-card input:-webkit-autofill:focus {
      -webkit-text-fill-color: #fff;
      transition: background-color 9999s ease-out 0s;
      box-shadow: 0 0 0px 1000px rgba(0,0,0,0.35) inset;
      border: 1px solid rgba(255,255,255,0.18);
      caret-color: #fff;
    }
    .admin-card textarea { min-height: 360px; resize: vertical; }
    .admin-weekly-schedule { margin-top: 1rem; }

    /* Admin header + login */
    .admin-title {
      margin-top: 1.2rem;
      font-size: 2.2rem;
      letter-spacing: 0.3px;
    }
    .admin-lede {
      color: var(--text-muted);
      margin-top: 0.35rem;
      line-height: 1.6;
    }

    /* Page hero */
    .admin-hero {
      padding: 1.6rem 1.6rem 1.4rem;
      background: radial-gradient(1000px 420px at 0% 0%, rgba(255,140,66,0.14), transparent 55%),
        rgba(255,255,255,0.03);
      box-shadow: 0 0 30px rgba(0,0,0,0.35);
    }
    .admin-hero-top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .admin-hero h1 { margin: 0; }
    .admin-hero code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 0.12rem 0.35rem;
      border-radius: 0.4rem;
      color: rgba(255,255,255,0.92);
    }
    .admin-statusbar {
      margin-top: 1rem;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.14);
      border-radius: 0.8rem;
      padding: 0.75rem 0.9rem;
      min-height: 2.25rem;
      display: flex;
      align-items: center;
    }

    /* Editor layout */
    .admin-editor { margin-top: 1.2rem; }
    .admin-editor-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 1rem;
    }
    .admin-editor-head h2 { margin: 0; }
    .admin-editor-sub { margin-top: 0.25rem; }
    .admin-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.86);
      font-weight: 800;
      letter-spacing: 0.3px;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .admin-panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (min-width: 980px) {
      .admin-panels { grid-template-columns: 1fr 1fr; }
      .admin-panels .span-2 { grid-column: 1 / -1; }
    }
    .admin-panel {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 0.9rem;
      background: rgba(0,0,0,0.12);
      padding: 1rem;
    }
    .admin-panel-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 0.8rem;
    }
    .admin-panel-head h3 { margin: 0; }

    /* Button polish (keeps existing palette) */
    .admin-actions button:hover { filter: brightness(1.05); }
    .admin-actions button:active { transform: translateY(1px); }
    .admin-actions button:focus-visible {
      outline: 2px solid rgba(255, 140, 66, 0.35);
      outline-offset: 2px;
    }

    .login-card {
      padding: 0;
      overflow: hidden;
      background: radial-gradient(1000px 420px at 0% 0%, rgba(255,140,66,0.14), transparent 55%),
        rgba(255,255,255,0.03);
      box-shadow: 0 0 30px rgba(0,0,0,0.35);
    }
    .login-top {
      padding: 1.35rem 1.35rem 0;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .login-top h2 { margin: 0; }
    .login-sub { margin: 0.35rem 0 0; color: var(--text-muted); }

    .login-shell {
      display: grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 1.2rem;
      padding: 1.2rem 1.35rem 1.35rem;
    }
    @media (max-width: 920px) {
      .login-shell { grid-template-columns: 1fr; }
    }

    .login-aside {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 0.9rem;
      padding: 1rem;
      min-height: 100%;
    }
    .login-aside h3 { margin: 0; font-size: 1rem; }
    .login-aside ul {
      margin: 0.65rem 0 0;
      padding-left: 1.1rem;
      color: rgba(255,255,255,0.75);
      line-height: 1.55;
    }

    .login-form {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.14);
      border-radius: 0.9rem;
      padding: 1rem;
    }
    .login-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.9rem;
      margin-top: 0.2rem;
    }
    @media (max-width: 620px) {
      .login-fields { grid-template-columns: 1fr; }
    }
    .login-form label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.78);
    }
    .login-form input {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 1rem;
      padding: 0.85rem 0.95rem;
      border-radius: 0.85rem;
      background: rgba(0,0,0,0.30);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .login-form input:focus {
      outline: 2px solid rgba(255, 140, 66, 0.35);
      outline-offset: 2px;
      border-color: rgba(255, 140, 66, 0.55);
    }
    .login-actions {
      display: flex;
      gap: 0.8rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .login-actions button {
      padding: 0.8rem 1.2rem;
      border-radius: 0.85rem;
      font-weight: 900;
      letter-spacing: 0.6px;
    }
    .login-status {
      color: var(--text-muted);
      min-height: 1.2em;
    }

    /* Admin schedule cards (match public schedule.html) */
    .admin-day-card { text-align: center; cursor: pointer; }
    .admin-day-card:hover { transform: none; }
    .admin-day-card .day-date {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .admin-day-card .status-pill.none { display: none; }

    .admin-day-card .admin-extra {
      font-size: 0.8rem;
      margin-top: 0.35rem;
      font-weight: 600;
    }
    .admin-day-card .admin-extra a {
      color: #66BB6A;
      text-decoration: none;
      display: inline-block;
    }
    .admin-day-card .admin-extra a:hover { text-decoration: underline; }
    .admin-day-card .admin-extra.cancelled { color: #ff6666; }
    .admin-day-card .admin-extra.delayed { color: #FFB74D; }

    .admin-day-card details.admin-edit {
      margin-top: 0.5rem;
      text-align: left;
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 0.75rem;
    }
    /* When the editor is moved into the desktop panel, it is no longer inside .admin-day-card */
    .admin-edit {
      text-align: left;
    }
    .admin-day-card details.admin-edit summary {
      cursor: pointer;
      list-style: none;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.75rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
    }
    .admin-edit summary {
      cursor: pointer;
      list-style: none;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.75rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
    }
    .admin-day-card details.admin-edit summary::-webkit-details-marker { display: none; }
    .admin-day-card details.admin-edit[open] summary { background: rgba(255,255,255,0.10); }
    .admin-edit summary::-webkit-details-marker { display: none; }
    .admin-edit[open] summary { background: rgba(255,255,255,0.10); }

    .admin-day-card .admin-edit-content {
      margin-top: 0.9rem;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 0.8rem;
      padding: 1rem;
      cursor: default;
    }
    .admin-edit .admin-edit-content {
      margin-top: 0.9rem;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 0.8rem;
      padding: 1rem;
      cursor: default;
    }

    .admin-day-card .schedule-item .field { gap: 0.45rem; }
    .admin-edit .schedule-item .field { gap: 0.45rem; }
    .admin-day-card .schedule-item .field label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.78);
    }
    .admin-edit .schedule-item .field label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.78);
    }
    .admin-day-card .schedule-item .field small {
      font-size: 0.82rem;
      line-height: 1.35;
      color: rgba(255,255,255,0.62);
    }
    .admin-edit .schedule-item .field small {
      font-size: 0.82rem;
      line-height: 1.35;
      color: rgba(255,255,255,0.62);
    }
    .admin-day-card .schedule-item input,
    .admin-day-card .schedule-item select,
    .admin-day-card .schedule-item textarea {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 0.95rem;
      padding: 0.75rem 0.9rem;
      border-radius: 0.75rem;
      background: rgba(0,0,0,0.26);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.95);
    }
    .admin-edit .schedule-item input,
    .admin-edit .schedule-item select,
    .admin-edit .schedule-item textarea {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 0.95rem;
      padding: 0.75rem 0.9rem;
      border-radius: 0.75rem;
      background: rgba(0,0,0,0.26);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.95);
    }
    .admin-day-card .schedule-item input:focus,
    .admin-day-card .schedule-item select:focus,
    .admin-day-card .schedule-item textarea:focus {
      outline: 2px solid rgba(255, 140, 66, 0.35);
      outline-offset: 2px;
      border-color: rgba(255, 140, 66, 0.55);
    }
    .admin-edit .schedule-item input:focus,
    .admin-edit .schedule-item select:focus,
    .admin-edit .schedule-item textarea:focus {
      outline: 2px solid rgba(255, 140, 66, 0.35);
      outline-offset: 2px;
      border-color: rgba(255, 140, 66, 0.55);
    }
    .admin-day-card .schedule-item input[disabled],
    .admin-day-card .schedule-item select[disabled],
    .admin-day-card .schedule-item textarea[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }
    .admin-edit .schedule-item input[disabled],
    .admin-edit .schedule-item select[disabled],
    .admin-edit .schedule-item textarea[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .admin-day-card .date-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 4.5rem;
      gap: 0.6rem;
      align-items: center;
    }
    .admin-edit .date-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 4.5rem;
      gap: 0.6rem;
      align-items: center;
    }

    .admin-day-card .date-row .month,
    .admin-edit .date-row .month {
      min-width: 0;
      width: 100%;
    }

    .admin-day-card .date-row .day,
    .admin-edit .date-row .day {
      width: 100%;
      text-align: center;
      padding-right: 0.6rem;
    }

    /* Number spinners steal horizontal room; remove for consistent sizing */
    .admin-day-card .date-row .day::-webkit-outer-spin-button,
    .admin-day-card .date-row .day::-webkit-inner-spin-button,
    .admin-edit .date-row .day::-webkit-outer-spin-button,
    .admin-edit .date-row .day::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .admin-day-card .date-row .day,
    .admin-edit .date-row .day {
      appearance: textfield;
    }
    /* Add breathing room between Date/Time and the next section */
    .admin-edit .schedule-item .field.field-date,
    .admin-edit .schedule-item .field.field-time {
      margin-bottom: 0.45rem;
    }
    .admin-day-card .vod-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.78);
      margin-top: 0.2rem;
    }
    .admin-edit .vod-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.78);
      margin-top: 0.2rem;
    }

    .admin-day-card .editor-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.7rem;
      margin-bottom: 0.9rem;
      flex-wrap: wrap;
    }
    .admin-edit .editor-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.7rem;
      margin-bottom: 0.9rem;
      flex-wrap: wrap;
    }

    .admin-day-card .status-chips {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }
    .admin-edit .status-chips {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .admin-day-card .chip {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      border-radius: 999px;
      padding: 0.4rem 0.7rem;
      font-weight: 800;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 0.72rem;
      cursor: pointer;
      user-select: none;
    }
    .admin-day-card .chip:hover { background: rgba(255,255,255,0.10); }
    .admin-day-card .chip.active { border-color: rgba(255, 140, 66, 0.55); background: rgba(255, 140, 66, 0.14); }
    .admin-day-card .chip.danger.active { border-color: rgba(255, 68, 68, 0.65); background: rgba(255, 68, 68, 0.14); }
    .admin-day-card .chip.ok.active { border-color: rgba(76, 175, 80, 0.55); background: rgba(76, 175, 80, 0.14); }
    .admin-day-card .chip.warn.active { border-color: rgba(255, 183, 77, 0.65); background: rgba(255, 183, 77, 0.16); }

    .admin-edit .chip {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      border-radius: 999px;
      padding: 0.4rem 0.7rem;
      font-weight: 800;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 0.72rem;
      cursor: pointer;
      user-select: none;
    }
    .admin-edit .chip:hover { background: rgba(255,255,255,0.10); }
    .admin-edit .chip.active { border-color: rgba(255, 140, 66, 0.55); background: rgba(255, 140, 66, 0.14); }
    .admin-edit .chip.danger.active { border-color: rgba(255, 68, 68, 0.65); background: rgba(255, 68, 68, 0.14); }
    .admin-edit .chip.ok.active { border-color: rgba(76, 175, 80, 0.55); background: rgba(76, 175, 80, 0.14); }
    .admin-edit .chip.warn.active { border-color: rgba(255, 183, 77, 0.65); background: rgba(255, 183, 77, 0.16); }
    .admin-edit .chip[disabled] { opacity: 0.55; cursor: not-allowed; }

    .admin-day-card .editor-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .admin-edit .editor-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .admin-day-card .mini-btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.92);
      border-radius: 0.75rem;
      padding: 0.45rem 0.7rem;
      font-weight: 800;
      font-size: 0.78rem;
      cursor: pointer;
      user-select: none;
    }
    .admin-day-card .mini-btn:hover { background: rgba(255,255,255,0.06); }

    .admin-edit .mini-btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.92);
      border-radius: 0.75rem;
      padding: 0.45rem 0.7rem;
      font-weight: 800;
      font-size: 0.78rem;
      cursor: pointer;
      user-select: none;
    }
    .admin-edit .mini-btn:hover { background: rgba(255,255,255,0.06); }
    .admin-edit .mini-btn[disabled] { opacity: 0.55; cursor: not-allowed; }

    /* Desktop-only two-pane layout: cards left, editor right */
    .admin-schedule-shell { display: block; }
    .desktop-editor { display: none; }
    .admin-schedule-controls { margin-top: 0.8rem; }

    .desktop-editor-card {
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      border-radius: 1rem;
      padding: 1rem;
      position: sticky;
      top: 1rem;
      max-height: calc(100vh - 2rem);
      overflow: auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.35);
    }
    .desktop-editor-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 0.9rem;
    }
    .desktop-editor-title { margin: 0; font-size: 1.1rem; }
    .desktop-editor-sub { margin: 0.2rem 0 0; color: var(--text-muted); font-size: 0.9rem; }
    .desktop-editor-empty { color: var(--text-muted); line-height: 1.6; }
    .admin-day-card.is-selected {
      outline: 2px solid rgba(255, 140, 66, 0.35);
      outline-offset: 2px;
    }

    @media (min-width: 1100px) {
      .admin-schedule-shell {
        display: grid;
        grid-template-columns: 1fr 430px;
        gap: 1.5rem;
        align-items: start;
      }
      .desktop-editor { display: block; }
      /* Hide embedded editors on desktop; use right panel instead */
      .admin-day-card details.admin-edit { display: none !important; }

      /* When editor is rendered in the desktop panel */
      .desktop-editor-body details.admin-edit { margin-top: 0; border-top: none; padding-top: 0; }
      .desktop-editor-body details.admin-edit > summary { display: none; }
      .desktop-editor-body .admin-edit-content { margin-top: 0; }
      /* Controls are still useful but take less visual weight */
      .admin-schedule-controls .admin-msg { display: none; }

      /* Fix: force single-column for delayed status in desktop editor */
      .desktop-editor-body .schedule-item.is-delayed {
        grid-template-columns: 1fr !important;
      }
      .desktop-editor-body .schedule-item.is-delayed .field-day,
      .desktop-editor-body .schedule-item.is-delayed .field-date,
      .desktop-editor-body .schedule-item.is-delayed .field-time,
      .desktop-editor-body .schedule-item.is-delayed .field-delayed,
      .desktop-editor-body .schedule-item.is-delayed .field-title,
      .desktop-editor-body .schedule-item.is-delayed .field-status {
        grid-column: 1 / -1 !important;
      }
    }
    .admin-day-card .schedule-item {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.9rem;
      padding: 0;
    }
    .admin-edit .schedule-item {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.9rem;
      padding: 0;
    }

    /* Reset legacy 12-col positioning rules within admin card editor */
    .admin-day-card .schedule-item .field,
    .admin-day-card .schedule-item .field-day,
    .admin-day-card .schedule-item .field-date,
    .admin-day-card .schedule-item .field-time,
    .admin-day-card .schedule-item .field-title,
    .admin-day-card .schedule-item .field-status,
    .admin-day-card .schedule-item .field-delayed {
      grid-column: auto;
    }
    .admin-edit .schedule-item .field,
    .admin-edit .schedule-item .field-day,
    .admin-edit .schedule-item .field-date,
    .admin-edit .schedule-item .field-time,
    .admin-edit .schedule-item .field-title,
    .admin-edit .schedule-item .field-status,
    .admin-edit .schedule-item .field-delayed {
      grid-column: auto;
    }
    @media (min-width: 840px) {
      .admin-day-card .schedule-item { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .admin-edit .schedule-item { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .admin-day-card .schedule-item .field-day,
      .admin-day-card .schedule-item .field-date,
      .admin-day-card .schedule-item .field-time { grid-column: auto; }
      .admin-edit .schedule-item .field-day,
      .admin-edit .schedule-item .field-date,
      .admin-edit .schedule-item .field-time { grid-column: auto; }
      .admin-day-card .schedule-item .field.field-status,
      .admin-day-card .schedule-item .field.field-title,
      .admin-day-card .schedule-item .field.field-delayed { grid-column: 1 / -1; }
      .admin-edit .schedule-item .field.field-status,
      .admin-edit .schedule-item .field.field-title,
      .admin-edit .schedule-item .field.field-delayed { grid-column: 1 / -1; }
    }

    /* Mobile-friendly day cards */
    .schedule-day {
      border-radius: 0.8rem;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .schedule-day summary {
      cursor: pointer;
      list-style: none;
      padding: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      user-select: none;
    }
    .schedule-day summary::-webkit-details-marker { display: none; }
    .schedule-day .summary-left { display: flex; flex-direction: column; gap: 0.2rem; min-width: 0; }
    .schedule-day .summary-top { display: flex; align-items: baseline; gap: 0.6rem; flex-wrap: wrap; }
    .schedule-day .summary-day { font-weight: 900; letter-spacing: 0.6px; }
    .schedule-day .summary-date { color: var(--text-muted); font-weight: 800; }
    .schedule-day .summary-sub {
      display: flex;
      gap: 0.6rem;
      color: var(--text-muted);
      font-size: 0.88rem;
      line-height: 1.2;
      min-width: 0;
      flex-wrap: wrap;
    }
    .schedule-day .summary-time { white-space: nowrap; }
    .schedule-day .summary-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 42ch; }
    .schedule-day .summary-right { display: flex; align-items: center; gap: 0.6rem; }
    .schedule-day .chev { color: var(--text-muted); font-weight: 900; transform: rotate(0deg); transition: transform 120ms ease; }
    .schedule-day[open] .chev { transform: rotate(90deg); }

    .schedule-day .status-pill {
      font-size: 0.72rem;
      font-weight: 900;
      letter-spacing: 0.7px;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.92);
      text-transform: uppercase;
      white-space: nowrap;
    }
    .schedule-day .status-pill.none { display: none; }
    .schedule-day .status-pill.scheduled { border-color: rgba(255, 140, 66, 0.5); background: rgba(255, 140, 66, 0.12); color: #FFB88A; }
    .schedule-day .status-pill.delayed { border-color: rgba(255, 183, 77, 0.65); background: rgba(255, 183, 77, 0.16); color: #FFD9A6; }
    .schedule-day .status-pill.cancelled { border-color: rgba(255, 68, 68, 0.6); background: rgba(255, 68, 68, 0.14); color: #ff9a9a; }
    .schedule-day .status-pill.completed { border-color: rgba(76, 175, 80, 0.55); background: rgba(76, 175, 80, 0.14); color: #9BE7A0; }

    .schedule-item {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 0.9rem;
      align-items: start;
      padding: 0.9rem;
    }
    .schedule-item .field { min-width: 0; }
    .schedule-item .field-day { grid-column: 1 / span 2; }
    .schedule-item .field-date { grid-column: 3 / span 3; }
    .schedule-item .field-time { grid-column: 6 / span 2; }
    .schedule-item .field-title { grid-column: 8 / span 3; }
    .schedule-item .field-status { grid-column: 11 / span 2; }
    /* Default placement for delayed field (when visible) */
    .schedule-item .field-delayed { grid-column: 8 / span 3; }
    /* When delayed is active, move Title to its own line for breathing room */
    .schedule-item.is-delayed .field-time { grid-column: 6 / span 2; }
    .schedule-item.is-delayed .field-delayed { grid-column: 8 / span 3; }
    .schedule-item.is-delayed .field-status { grid-column: 11 / span 2; }
    .schedule-item.is-delayed .field-title { grid-column: 1 / span 12; }
    .schedule-item .field { display: flex; flex-direction: column; gap: 0.35rem; }
    .schedule-item .field small { color: var(--text-muted); }
    .schedule-item .toggle {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.65rem 0.9rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #fff;
      user-select: none;
    }
    .schedule-item input[type="checkbox"] { width: 18px; height: 18px; padding: 0; }
    .schedule-header-row {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 0.7rem;
      color: var(--text-muted);
      font-weight: 700;
      font-size: 0.85rem;
      padding: 0 0.2rem;
    }
    .schedule-header-row > div:nth-child(1) { grid-column: 1 / span 2; }
    .schedule-header-row > div:nth-child(2) { grid-column: 3 / span 3; }
    .schedule-header-row > div:nth-child(3) { grid-column: 6 / span 2; }
    .schedule-header-row > div:nth-child(4) { grid-column: 8 / span 3; }
    .schedule-header-row > div:nth-child(5) { grid-column: 11 / span 2; }
    .advanced {
      margin-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 1rem;
    }
    .advanced details { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 0.8rem; padding: 0.9rem; }
    .advanced summary { cursor: pointer; color: #e0e0e0; font-weight: 700; }
    .admin-actions { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center; }
    .admin-actions .spacer { flex: 1; }
    .admin-actions button {
      background: var(--primary);
      border: none;
      color: #fff;
      padding: 0.7rem 1.1rem;
      border-radius: 0.6rem;
      cursor: pointer;
      font-weight: 700;
    }
    .admin-actions button.secondary { background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.18); }
    .admin-actions button.danger { background: rgba(255, 90, 90, 0.20); border: 1px solid rgba(255, 90, 90, 0.35); }
    .admin-msg { color: var(--text-muted); }
    .admin-msg.ok { color: #66BB6A; }
    .admin-msg.err { color: #ff6666; }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
    .hidden { display: none !important; }
    @media (max-width: 980px) {
      /* Wide phones/tablets: clean 2-col layout + full-width Status */
      .admin-row { grid-template-columns: 1fr; }
      .schedule-header-row { display: none; }

      .admin-wrap { padding: 1.2rem; }
      .admin-card { padding: 1.1rem; }

      .schedule-item {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.85rem;
        padding: 1rem;
        align-items: start;
      }

      .schedule-item .field-day { grid-column: 1; }
      .schedule-item .field-date { grid-column: 2; }
      .schedule-item .field-time { grid-column: 1; }
      .schedule-item .field-title { grid-column: 2; }

      .schedule-item .field.field-status { grid-column: 1 / -1; }
      .schedule-item .field.field-delayed { grid-column: 1 / -1; }

      /* Delayed/completed can have extra inputs; give them room */
      .schedule-item.is-delayed { grid-template-columns: 1fr; }
      .schedule-item.is-delayed .field-day,
      .schedule-item.is-delayed .field-date,
      .schedule-item.is-delayed .field-time,
      .schedule-item.is-delayed .field-delayed,
      .schedule-item.is-delayed .field-title,
      .schedule-item.is-delayed .field-status { grid-column: 1 / -1; }
    }

    @media (max-width: 520px) {
      /* Small phones: single column */
      .schedule-item { grid-template-columns: 1fr; align-items: start; }
      .schedule-item .field-day,
      .schedule-item .field-date,
      .schedule-item .field-time,
      .schedule-item .field-title,
      .schedule-item .field-status,
      .schedule-item .field-delayed { grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">flywithjoel</div>
      <ul class="nav-links" style="gap: 1rem;">
        <li><a href="/">Home</a></li>
      </ul>
    </div>
  </nav>

  <main class="admin-wrap">
    <header class="admin-card admin-hero">
      <div class="admin-hero-top">
        <div>
          <h1 class="admin-title">ğŸ› ï¸ Schedule Admin</h1>
          <p class="admin-lede">ğŸ” Sign in to edit the schedule. This page saves to <code>/api/schedule</code> (Cloudflare Worker + KV).</p>
        </div>
        <div class="admin-pill" aria-label="Admin area">ğŸ”’ Admin-only</div>
      </div>

      <div class="admin-statusbar" aria-live="polite">
        <div id="status-bar" class="admin-msg"></div>
      </div>
    </header>

    <div id="login-card" class="admin-card login-card">
      <div class="login-top">
        <div>
          <h2>ğŸ”‘ Admin Login</h2>
          <p class="login-sub">Enter your Worker username/password to unlock editing.</p>
        </div>
      </div>

      <div class="login-shell">
        <div class="login-aside">
          <h3>ğŸ”’ What this does</h3>
          <ul>
            <li>Unlocks schedule + site mode controls</li>
            <li>Uses Basic Auth to call the Worker endpoints</li>
            <li>Credentials are not stored by this page</li>
          </ul>
        </div>

        <div class="login-form">
          <div class="login-fields">
            <div>
              <label for="admin-user">Username</label>
              <input id="admin-user" type="text" autocomplete="username" />
            </div>
            <div>
              <label for="admin-pass">Password</label>
              <input id="admin-pass" type="password" autocomplete="current-password" />
            </div>
          </div>

          <div class="login-actions">
            <button id="btn-unlock" type="button">ğŸ”“ Unlock</button>
            <span id="status" class="login-status" aria-live="polite"></span>
          </div>
        </div>
      </div>
    </div>

    <div id="editor-card" class="admin-card admin-editor hidden">
      <div class="admin-grid">
        <div class="admin-editor-head">
          <div>
            <h2>ğŸ“… 7 Day Schedule</h2>
            <p class="admin-msg admin-editor-sub">Edit each day: month/day, time (Zulu), and whether there is a stream.</p>
          </div>
          <div id="signed-in-pill" class="admin-pill">âœ… Signed in</div>
        </div>

        <div class="admin-panels">
          <section class="admin-panel" aria-label="Site mode controls">
            <div class="admin-panel-head">
              <div>
                <h3>ğŸ§¯ Site Mode</h3>
                <p class="admin-msg" style="margin-top: 0.2rem;">Switch the public site between Live and Maintenance (<code>/pages/maintenance.html</code>).</p>
              </div>
              <div id="site-mode-pill" class="admin-pill">Mode: â€¦</div>
            </div>

            <div class="admin-actions">
              <button id="btn-site-refresh" class="secondary" type="button">â†» Refresh</button>
              <button id="btn-site-live" class="secondary" type="button">âœ… Set Live</button>
              <button id="btn-site-maint" class="danger" type="button">ğŸ”§ Maintenance</button>
              <span class="spacer"></span>
              <span id="site-mode-status" class="admin-msg"></span>
            </div>
          </section>

          <section class="admin-panel" aria-label="Maintenance message">
            <div class="admin-panel-head">
              <div>
                <h3>ğŸ—“ï¸ Expected Return</h3>
                <p class="admin-msg" style="margin-top: 0.2rem;">Message shown on the maintenance page.</p>
              </div>
            </div>

            <label for="expected-return-input">Expected return message</label>
            <input id="expected-return-input" type="text" maxlength="120" style="margin-bottom:0.7rem;" />
            <div class="admin-actions">
              <button id="btn-expected-return-save" type="button">ğŸ’¾ Save</button>
              <span id="expected-return-status" class="admin-msg" style="margin-left:1rem;"></span>
            </div>
          </section>

          <section class="admin-panel span-2" aria-label="Security incident notice">
            <div class="admin-panel-head">
              <div>
                <h3>ğŸš¨ Security Incident Notice</h3>
                <p class="admin-msg" style="margin-top: 0.2rem;">Shows a banner site-wide (no email required). Links to <code>/pages/status.html</code> and <code>/pages/security.html</code>.</p>
              </div>
              <div id="incident-pill" class="admin-pill">Incident: â€¦</div>
            </div>

            <div class="admin-row" style="margin-bottom: 0.7rem;">
              <div>
                <label for="incident-enabled">Enabled</label>
                <select id="incident-enabled">
                  <option value="0">Off</option>
                  <option value="1">On</option>
                </select>
              </div>
              <div>
                <label for="incident-updated">Last updated (UTC)</label>
                <input id="incident-updated" type="text" disabled />
              </div>
            </div>

            <div class="admin-row" style="margin-bottom: 0.7rem;">
              <div>
                <label for="incident-title">Title (max 80)</label>
                <input id="incident-title" type="text" maxlength="80" placeholder="Weâ€™re investigating a potential security incident" />
              </div>
              <div>
                <label for="incident-message">Message (max 220)</label>
                <input id="incident-message" type="text" maxlength="220" placeholder="Short, factual summary and what users should do" />
              </div>
            </div>

            <div class="admin-actions">
              <button id="btn-incident-refresh" class="secondary" type="button">â†» Refresh</button>
              <button id="btn-incident-save" type="button">ğŸ’¾ Save</button>
              <span class="spacer"></span>
              <label class="admin-msg" style="display:flex; align-items:center; gap:0.5rem; margin:0;">
                <input id="incident-notify" type="checkbox" />
                Notify me (browser)
              </label>
              <span class="spacer"></span>
              <span id="incident-status" class="admin-msg"></span>
            </div>
          </section>

          <section class="admin-panel span-2" aria-label="Discord message preview">
            <div class="admin-panel-head">
              <div>
                <h3>ğŸ’¬ Discord Message Preview</h3>
                <p class="admin-msg" style="margin-top: 0.2rem;">Copy/paste this to Discord.</p>
              </div>
            </div>

            <label for="discord-message-preview">Preview</label>
            <textarea id="discord-message-preview" readonly style="min-height:180px; margin-bottom:0.7rem;"></textarea>
            <div class="admin-actions">
              <button id="btn-generate-discord-message" type="button">ğŸ”„ Generate</button>
            </div>
          </section>

          <section class="admin-panel span-2" aria-label="Admin notes">
            <div class="admin-panel-head">
              <div>
                <h3>ğŸ“ Notes</h3>
                <p class="admin-msg" style="margin-top: 0.2rem;">Saved to your admin login.</p>
              </div>
            </div>

            <label for="admin-notes">Notes</label>
            <textarea id="admin-notes" spellcheck="true" style="min-height:160px; margin-bottom:0.7rem;" placeholder="Add notes for yourselfâ€¦"></textarea>
            <div class="admin-actions">
              <span id="admin-notes-status" class="admin-msg"></span>
            </div>
          </section>
        </div>

        <div>
          <div class="admin-schedule-shell">
            <div class="admin-schedule-left">
              <div id="schedule-grid" class="weekly-schedule admin-weekly-schedule"></div>

              <div class="admin-actions admin-schedule-controls">
                <button id="btn-expand-all" class="secondary" type="button">â–¾ Expand all</button>
                <button id="btn-collapse-all" class="secondary" type="button">â–¸ Collapse all</button>
                <span class="spacer"></span>
                <span class="admin-msg">Tip: click a card to open its editor.</span>
              </div>
            </div>

            <aside class="desktop-editor" aria-label="Desktop editor panel">
              <div class="desktop-editor-card">
                <div class="desktop-editor-head">
                  <div>
                    <h3 id="desktop-editor-title" class="desktop-editor-title">âœï¸ Edit day</h3>
                    <p id="desktop-editor-sub" class="desktop-editor-sub">Select a day card to edit.</p>
                  </div>
                  <div class="admin-actions" style="gap: 0.5rem;">
                    <button id="btn-editor-prev" class="secondary" type="button">â† Prev</button>
                    <button id="btn-editor-next" class="secondary" type="button">Next â†’</button>
                    <button id="btn-editor-close" class="danger" type="button">âœ• Close</button>
                  </div>
                </div>

                <div id="desktop-editor-body" class="desktop-editor-body">
                  <p class="desktop-editor-empty">Pick a day card on the left to load its editor here. This keeps the grid stable while you edit.</p>
                </div>
              </div>
            </aside>
          </div>

          <div class="advanced">
            <details>
              <summary>ğŸ§ª Advanced (raw JSON)</summary>
              <p class="admin-msg">Optional. This is what gets saved to the API.</p>
              <textarea id="schedule-json" spellcheck="false"></textarea>
            </details>
          </div>
        </div>

        <div class="admin-actions">
          <button id="btn-load" class="secondary" type="button">ğŸ”„ Load current</button>
          <button id="btn-reset-rolling" class="secondary" type="button">ğŸ—“ï¸ Reset to Rolling 7 Days</button>
          <button id="btn-format" class="secondary" type="button">ğŸ§© Sync JSON</button>
          <button id="btn-save" type="button">ğŸ’¾ Save schedule</button>
          <button id="btn-export-ics" class="secondary" type="button">ğŸ“… Export to Google Calendar</button>
          <span class="spacer"></span>
          <button id="btn-lock" class="danger" type="button">ğŸ”’ Lock</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Export to Google Calendar (.ics) ---
    function scheduleToICS(schedule) {
      function pad(n) { return n.toString().padStart(2, '0'); }
      const now = new Date();
      const year = now.getFullYear();
      let ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Flying With Joel//Stream Schedule//EN'
      ];
      for (const item of schedule) {
        if (!item || item.status === 'none' || /no stream/i.test(item.timeText)) continue;
        // Parse date
        const [month, day] = item.dateKey.split('-').map(Number);
        // Parse time (e.g., "18:00 Zulu")
        let timeMatch = (item.zuluTime || '').match(/(\d{1,2}):(\d{2})/);
        let hour = timeMatch ? timeMatch[1] : '18';
        let minute = timeMatch ? timeMatch[2] : '00';
        // Format as YYYYMMDDTHHMMSSZ
        const dt = `${year}${pad(month)}${pad(day)}T${pad(hour)}${pad(minute)}00Z`;
        ics.push('BEGIN:VEVENT');
        ics.push(`SUMMARY:${item.streamTitle || 'Stream'}`);
        ics.push(`DTSTART:${dt}`);
        ics.push(`DTEND:${dt}`); // Optionally add +2 hours
        ics.push(`DESCRIPTION:${item.timeText}`);
        ics.push('END:VEVENT');
      }
      ics.push('END:VCALENDAR');
      return ics.join('\r\n');
    }

    function downloadICSFile(icsContent, filename) {
      const blob = new Blob([icsContent], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const btnExportICS = document.getElementById('btn-export-ics');
      if (btnExportICS) {
        btnExportICS.addEventListener('click', function() {
          const schedule = scheduleFromEditor();
          const ics = scheduleToICS(schedule);
          downloadICSFile(ics, 'stream-schedule.ics');
        });
      }
    });
    // --- Discord Message Generator ---
    function generateDiscordMessage(schedule) {
      if (!schedule || schedule.length === 0) return '';
      // Header line with date range
      const first = schedule[0];
      const last = schedule[schedule.length - 1];
      const range = `*${first.dateText} --> ${last.dateText}*`;
      let lines = [];
      lines.push(`------------- ${range} ------------------\n`);

      // Manual layout: emoji (13), day (12), date (18), dash, message
      // Example: ':Taino_No:     Monday 26th January  -   **No Stream**'
      //         ':Twitch:       Tuesday 27th January  -  **Stream @ 18:00 Zulu**'
      //         ':Taino_No:         Wednesday 28th January  -  **No Stream**'
      //         ':Twitch:        Thursday 29th January     -    **Stream @ 12:00 Zulu **'
      //         ':Twitch:       Friday 30th January - **Stream @ 18:00 Zulu **'
      //         ':Twitch:     Saturday 31st January   -   **Stream @ 12:00pm Zulu**'
      //         ':Twitch:      Sunday 1st February- **Stream @ 11:00am Zulu **'

      // Find max lengths for day+date for best alignment
      // Map short day names to full names
      const dayNameMap = {
        'MON': 'Monday',
        'TUE': 'Tuesday',
        'WED': 'Wednesday',
        'THU': 'Thursday',
        'FRI': 'Friday',
        'SAT': 'Saturday',
        'SUN': 'Sunday'
      };

      let dayDateArr = schedule.map(item => {
        const shortDay = (item.dayName || '').toUpperCase();
        const fullDay = dayNameMap[shortDay] || item.dayName;
        return `${fullDay} ${item.dateText}`;
      });
      let maxDayDate = Math.max(...dayDateArr.map(s => s.length));

      for (const item of schedule) {
        let emoji = ':Taino_No:';
        let msg = '';
        if (item.status && item.status !== 'none') {
          emoji = ':Twitch:';
          msg = `**Stream @ ${item.timeText}**`;
        } else {
          msg = '**No Stream**';
        }
        // Use full day name
        const shortDay = (item.dayName || '').toUpperCase();
        const fullDay = dayNameMap[shortDay] || item.dayName;
        // Pad emoji to 13, day+date to maxDayDate+2, dash to 3 spaces after
        const emojiStr = emoji.padEnd(13, ' ');
        const dayDateStr = (`${fullDay} ${item.dateText}`).padEnd(maxDayDate + 2, ' ');
        // For some lines, add extra spaces after dash for visual match
        let dashSpaces = '   ';
        if (fullDay === 'Thursday') dashSpaces = '    ';
        if (fullDay === 'Saturday') dashSpaces = '   ';
        if (fullDay === 'Sunday') dashSpaces = '';
        if (fullDay === 'Friday') dashSpaces = '';
        if (fullDay === 'Wednesday') dashSpaces = '  ';
        if (fullDay === 'Tuesday') dashSpaces = '  ';
        if (fullDay === 'Monday') dashSpaces = '   ';

        let line = `${emojiStr}${dayDateStr}- ${dashSpaces}${msg}`;
        lines.push(line + '\n');
        lines.push('\n');
      }
      return lines.join('').trim();
    }

    function updateDiscordMessagePreview() {
      const schedule = scheduleFromEditor();
      const msg = generateDiscordMessage(schedule);
      const previewEl = document.getElementById('discord-message-preview');
      if (previewEl) previewEl.value = msg;
    }

    // Wire up button
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('btn-generate-discord-message');
      if (btn) btn.addEventListener('click', updateDiscordMessagePreview);
      // Auto-generate on load
      updateDiscordMessagePreview();
    });

    // Also update preview whenever the schedule changes
    const origRenderEditor = renderEditor;
    renderEditor = function(items) {
      origRenderEditor(items);
      updateDiscordMessagePreview();
    };
    // --- Reset to Rolling 7 Days ---
    // NOTE: This intentionally excludes "today" and loads the NEXT 7 days.
    const btnResetRollingEl = document.getElementById('btn-reset-rolling');
    if (btnResetRollingEl) {
      btnResetRollingEl.addEventListener('click', () => {
        const items = buildEmptySchedule(1);
        renderEditor(items);
        setStatus('Reset to rolling 7 days. Click Save to apply.', 'ok');
      });
    }
    const statusEl = document.getElementById('status');
    const statusBarEl = document.getElementById('status-bar');
    const userEl = document.getElementById('admin-user');
    const passEl = document.getElementById('admin-pass');
    const jsonEl = document.getElementById('schedule-json');
    const scheduleGridEl = document.getElementById('schedule-grid');
    const loginCardEl = document.getElementById('login-card');
    const editorCardEl = document.getElementById('editor-card');
    const signedInPillEl = document.getElementById('signed-in-pill');

    const siteModePillEl = document.getElementById('site-mode-pill');
    const siteModeStatusEl = document.getElementById('site-mode-status');
    const expectedReturnInputEl = document.getElementById('expected-return-input');
    const btnExpectedReturnSaveEl = document.getElementById('btn-expected-return-save');
    const expectedReturnStatusEl = document.getElementById('expected-return-status');

    const incidentPillEl = document.getElementById('incident-pill');
    const incidentEnabledEl = document.getElementById('incident-enabled');
    const incidentUpdatedEl = document.getElementById('incident-updated');
    const incidentTitleEl = document.getElementById('incident-title');
    const incidentMessageEl = document.getElementById('incident-message');
    const btnIncidentRefreshEl = document.getElementById('btn-incident-refresh');
    const btnIncidentSaveEl = document.getElementById('btn-incident-save');
    const incidentStatusEl = document.getElementById('incident-status');
    const incidentNotifyEl = document.getElementById('incident-notify');

    // --- Admin Notes (server-side, tied to admin login) ---
    // Stored behind Basic Auth in the Schedule API backend.
    const adminNotesEl = document.getElementById('admin-notes');
    const adminNotesStatusEl = document.getElementById('admin-notes-status');
    let adminNotesSaveTimer = null;
    const DEFAULT_ADMIN_NOTES = 'Note:\nDad Thinks im in college on\n\nMONDAY\nTUESDAY\nFRIDAY\n.';

    function setAdminNotesStatus(text) {
      if (!adminNotesStatusEl) return;
      adminNotesStatusEl.textContent = (text || '').toString();
    }

    function deriveAdminNotesApiUrl(scheduleApiUrl) {
      const u = (scheduleApiUrl || '').toString().trim();
      if (!u) return null;
      // Worker style: /api/schedule -> /api/schedule/admin-notes
      if (u.endsWith('/api/schedule')) return u + '/admin-notes';
      // FastHosts fallback style: schedule.php -> admin_notes.php
      if (/schedule\.php$/i.test(u)) return u.replace(/schedule\.php$/i, 'admin_notes.php');
      return null;
    }

    function getAdminNotesApiCandidates() {
      const override = getScheduleApiOverride();
      const derived = deriveAdminNotesApiUrl(override);
      const candidates = [
        derived,
        '/api/schedule/admin-notes',
        'https://api.flyingwithjoel.co.uk/api/admin_notes.php',
      ].filter(Boolean);
      return Array.from(new Set(candidates));
    }

    async function loadAdminNotes() {
      const auth = authHeader;
      if (!adminNotesEl) return;
      if (!auth) {
        // Locked: don't attempt.
        setAdminNotesStatus('');
        return;
      }

      setAdminNotesStatus('Loadingâ€¦');
      try {
        const result = await fetchFirstOkJson(getAdminNotesApiCandidates(), {
          method: 'GET',
          cache: 'no-store',
          headers: { 'authorization': auth },
        });
        if (!result) throw new Error('No notes API responded.');

        const data = result.data;
        const notes = (data && typeof data.notes === 'string') ? data.notes : '';
        const updatedAtUtc = (data && typeof data.updatedAtUtc === 'string') ? data.updatedAtUtc : null;

        // If nothing has ever been saved yet, seed with a helpful default note.
        if (!notes && !updatedAtUtc) {
          adminNotesEl.value = DEFAULT_ADMIN_NOTES;
          setAdminNotesStatus('Loaded.');
          try { await saveAdminNotes(); } catch {}
          return;
        }

        adminNotesEl.value = notes;
        setAdminNotesStatus('Loaded.');
      } catch (e) {
        console.error(e);
        setAdminNotesStatus('Could not load notes.');
      }
    }

    async function saveAdminNotes() {
      const auth = authHeader;
      if (!adminNotesEl) return;
      if (!auth) return;

      const payload = { notes: adminNotesEl.value || '' };
      try {
        const targets = getAdminNotesApiCandidates();
        let savedUrl = null;
        let lastStatus = null;
        let lastBody = null;

        for (const u of targets) {
          try {
            const resp = await fetch(u, {
              method: 'PUT',
              headers: {
                'content-type': 'application/json',
                'authorization': auth,
              },
              body: JSON.stringify(payload),
            });

            lastStatus = resp.status;
            if (resp.status === 401) {
              setAdminNotesStatus('Unauthorized.');
              return;
            }

            if (!resp.ok) {
              try {
                lastBody = await resp.text();
              } catch {
                lastBody = null;
              }
              continue;
            }

            savedUrl = u;
            break;
          } catch {
            // try next
          }
        }

        if (!savedUrl) {
          const extra = lastBody ? ` (${String(lastBody).slice(0, 120)})` : '';
          throw new Error(`Save failed (last status: ${lastStatus ?? 'n/a'})${extra}`);
        }

        setAdminNotesStatus('Saved.');
      } catch (e) {
        console.error(e);
        setAdminNotesStatus('Save failed.');
      }
    }

    if (adminNotesEl) {
      adminNotesEl.addEventListener('input', () => {
        if (!authHeader) {
          setAdminNotesStatus('Unlock to save notes.');
          return;
        }
        setAdminNotesStatus('Savingâ€¦');
        if (adminNotesSaveTimer) clearTimeout(adminNotesSaveTimer);
        adminNotesSaveTimer = setTimeout(() => { saveAdminNotes(); }, 350);
      });
      window.addEventListener('beforeunload', () => {
        try { saveAdminNotes(); } catch {}
      });
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          try { saveAdminNotes(); } catch {}
        }
      });
    }
        // --- Expected Return Message ---
        function getExpectedReturnApiUrl() {
          // Use same logic as site mode API, but endpoint is /expected-return
          const base = getSiteModeApiOverride() || '/api/site-mode';
          if (base.endsWith('/')) return base + 'expected-return';
          if (base.endsWith('site-mode')) return base + '/expected-return';
          return base + '/expected-return';
        }

        function fetchExpectedReturnMessage() {
          expectedReturnInputEl.value = '';
          expectedReturnStatusEl.textContent = 'Loading...';
          fetch(getExpectedReturnApiUrl(), { cache: 'no-store' })
            .then(resp => resp.json())
            .then(data => {
              if (data && typeof data.message === 'string') {
                expectedReturnInputEl.value = data.message;
                expectedReturnStatusEl.textContent = 'Loaded.';
              } else {
                expectedReturnStatusEl.textContent = 'No message set.';
              }
            })
            .catch(() => {
              expectedReturnStatusEl.textContent = 'Error loading message.';
            });
        }

        function saveExpectedReturnMessage() {
          const msg = expectedReturnInputEl.value.trim();
          if (!msg || msg.length > 120) {
            expectedReturnStatusEl.textContent = 'Message must be 1-120 characters.';
            return;
          }
          expectedReturnStatusEl.textContent = 'Saving...';
          fetch(getExpectedReturnApiUrl(), {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              ...(authHeader ? { 'Authorization': authHeader } : {}),
            },
            body: JSON.stringify({ message: msg }),
          })
            .then(resp => resp.json())
            .then(data => {
              if (data && data.ok) {
                expectedReturnStatusEl.textContent = 'Saved!';
              } else {
                expectedReturnStatusEl.textContent = (data && data.error) ? data.error : 'Error saving.';
              }
            })
            .catch(() => {
              expectedReturnStatusEl.textContent = 'Error saving.';
            });
        }

        if (expectedReturnInputEl && btnExpectedReturnSaveEl) {
          btnExpectedReturnSaveEl.addEventListener('click', saveExpectedReturnMessage);
        }

        // Load message after unlock
        function afterUnlock() {
          // ...existing code...
          fetchExpectedReturnMessage();
        }
    const btnSiteRefreshEl = document.getElementById('btn-site-refresh');
    const btnSiteLiveEl = document.getElementById('btn-site-live');
    const btnSiteMaintEl = document.getElementById('btn-site-maint');

    const desktopEditorBodyEl = document.getElementById('desktop-editor-body');
    const desktopEditorTitleEl = document.getElementById('desktop-editor-title');
    const desktopEditorSubEl = document.getElementById('desktop-editor-sub');
    const btnEditorPrevEl = document.getElementById('btn-editor-prev');
    const btnEditorNextEl = document.getElementById('btn-editor-next');
    const btnEditorCloseEl = document.getElementById('btn-editor-close');

    const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const DEFAULT_DAYS = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

    const STATUSES = [
      { value: 'none', label: 'ğŸš« No stream' },
      { value: 'scheduled', label: 'ğŸ—“ï¸ Scheduled' },
      { value: 'live', label: 'ğŸ”´ Live' },
      { value: 'cancelled', label: 'âŒ Cancelled' },
      { value: 'delayed', label: 'â³ Delayed' },
      { value: 'completed', label: 'âœ… Completed' },
    ];

    const SCHEDULE_API_LOCALSTORAGE_KEY = 'fwj_schedule_api';
    const SITE_MODE_API_LOCALSTORAGE_KEY = 'fwj_site_mode_api';
    const INCIDENT_API_LOCALSTORAGE_KEY = 'fwj_incident_api';

    const INCIDENT_NOTIFY_ENABLED_KEY = 'fwj_admin_incident_notify_enabled';
    const INCIDENT_WATCH_STATE_KEY = 'fwj_admin_incident_watch_state';
    let incidentWatchTimer = null;

    function sanitizeApiUrl(raw) {
      const s = (raw || '').trim();
      if (!s) return null;
      // Allow absolute http(s) or same-origin relative paths.
      if (/^https?:\/\//i.test(s)) return s.replace(/\s+/g, '');
      if (s.startsWith('/')) return s;
      return null;
    }

    function getScheduleApiOverride() {
      // Query param wins and is persisted.
      try {
        const params = new URLSearchParams(window.location.search);
        const qp = sanitizeApiUrl(params.get('scheduleApi'));
        if (qp) {
          localStorage.setItem(SCHEDULE_API_LOCALSTORAGE_KEY, qp);
          return qp;
        }
      } catch {
        // ignore
      }

      try {
        const fromLs = sanitizeApiUrl(localStorage.getItem(SCHEDULE_API_LOCALSTORAGE_KEY));
        if (fromLs) return fromLs;
      } catch {
        // ignore
      }

      // Optional meta override.
      const meta = document.querySelector('meta[name="schedule-api"]');
      const metaVal = sanitizeApiUrl(meta ? meta.getAttribute('content') : '');
      return metaVal;
    }

    function getScheduleApiCandidates() {
      const override = getScheduleApiOverride();
      const candidates = [
        override,
        '/api/schedule',
        'https://api.flyingwithjoel.co.uk/api/schedule.php',
      ].filter(Boolean);

      // De-dupe
      return Array.from(new Set(candidates));
    }

    let authHeader = null;

    function getSiteModeApiOverride() {
      // Query param wins and is persisted.
      try {
        const params = new URLSearchParams(window.location.search);
        const qp = sanitizeApiUrl(params.get('siteModeApi'));
        if (qp) {
          localStorage.setItem(SITE_MODE_API_LOCALSTORAGE_KEY, qp);
          return qp;
        }
      } catch {
        // ignore
      }

      try {
        const fromLs = sanitizeApiUrl(localStorage.getItem(SITE_MODE_API_LOCALSTORAGE_KEY));
        if (fromLs) return fromLs;
      } catch {
        // ignore
      }

      // Optional meta override.
      const meta = document.querySelector('meta[name="site-mode-api"]');
      const metaVal = sanitizeApiUrl(meta ? meta.getAttribute('content') : '');
      return metaVal;
    }

    function getSiteModeApiCandidates() {
      const override = getSiteModeApiOverride();
      const candidates = [
        override,
        '/api/site-mode',
        'https://api.flyingwithjoel.co.uk/api/site_mode.php',
      ].filter(Boolean);
      return Array.from(new Set(candidates));
    }

    function getIncidentApiOverride() {
      // Query param wins and is persisted.
      try {
        const params = new URLSearchParams(window.location.search);
        const qp = sanitizeApiUrl(params.get('incidentApi'));
        if (qp) {
          localStorage.setItem(INCIDENT_API_LOCALSTORAGE_KEY, qp);
          return qp;
        }
      } catch {
        // ignore
      }

      try {
        const fromLs = sanitizeApiUrl(localStorage.getItem(INCIDENT_API_LOCALSTORAGE_KEY));
        if (fromLs) return fromLs;
      } catch {
        // ignore
      }

      // Optional meta override.
      const meta = document.querySelector('meta[name="incident-api"]');
      const metaVal = sanitizeApiUrl(meta ? meta.getAttribute('content') : '');
      return metaVal;
    }

    function getIncidentApiCandidates() {
      const override = getIncidentApiOverride();
      const candidates = [
        override,
        '/api/incident-notice',
        'https://api.flyingwithjoel.co.uk/api/incident_notice.php',
      ].filter(Boolean);
      return Array.from(new Set(candidates));
    }

    function setIncidentStatus(text, kind) {
      if (!incidentStatusEl) return;
      const cls = 'admin-msg' + (kind ? ` ${kind}` : '');
      incidentStatusEl.textContent = text || '';
      incidentStatusEl.className = cls;
    }

    function renderIncidentPill(enabled, updatedAtUtc) {
      if (!incidentPillEl) return;
      const label = enabled ? 'âœ… On' : 'ğŸš« Off';
      const when = updatedAtUtc ? ` (updated ${updatedAtUtc})` : '';
      incidentPillEl.textContent = `Incident: ${label}${when}`;
    }

    function fillIncidentForm(data) {
      const enabled = Boolean(data && data.enabled);
      if (incidentEnabledEl) incidentEnabledEl.value = enabled ? '1' : '0';
      if (incidentUpdatedEl) incidentUpdatedEl.value = (data && data.updatedAtUtc) ? String(data.updatedAtUtc) : '';
      if (incidentTitleEl) incidentTitleEl.value = (data && typeof data.title === 'string') ? data.title : '';
      if (incidentMessageEl) incidentMessageEl.value = (data && typeof data.message === 'string') ? data.message : '';
      renderIncidentPill(enabled, (data && data.updatedAtUtc) ? String(data.updatedAtUtc) : null);
    }

    function getIncidentNotifyEnabled() {
      try { return localStorage.getItem(INCIDENT_NOTIFY_ENABLED_KEY) === 'true'; } catch { return false; }
    }

    function setIncidentNotifyEnabled(enabled) {
      try { localStorage.setItem(INCIDENT_NOTIFY_ENABLED_KEY, enabled ? 'true' : 'false'); } catch {}
    }

    function readIncidentWatchState() {
      try {
        const raw = localStorage.getItem(INCIDENT_WATCH_STATE_KEY);
        if (!raw) return { initialized: false, enabled: false, updatedAtUtc: null };
        const p = JSON.parse(raw);
        return {
          initialized: Boolean(p && p.initialized),
          enabled: Boolean(p && p.enabled),
          updatedAtUtc: (p && typeof p.updatedAtUtc === 'string' && p.updatedAtUtc.trim()) ? p.updatedAtUtc.trim() : null,
        };
      } catch {
        return { initialized: false, enabled: false, updatedAtUtc: null };
      }
    }

    function writeIncidentWatchState(state) {
      try {
        const s = state || {};
        localStorage.setItem(INCIDENT_WATCH_STATE_KEY, JSON.stringify({
          initialized: Boolean(s.initialized),
          enabled: Boolean(s.enabled),
          updatedAtUtc: (s.updatedAtUtc && typeof s.updatedAtUtc === 'string') ? s.updatedAtUtc : null,
        }));
      } catch {
        // ignore
      }
    }

    async function ensureIncidentNotificationPermission() {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      try {
        const p = await Notification.requestPermission();
        return p === 'granted';
      } catch {
        return false;
      }
    }

    function notifyIncidentChange(next, prev) {
      const title = (next && typeof next.title === 'string' ? next.title : '').trim() || 'Security incident notice updated';
      const message = (next && typeof next.message === 'string' ? next.message : '').trim() || 'Open admin to view details.';

      // Always show in-page status (even if Notifications are blocked).
      setIncidentStatus('Incident updated on server. Click Refresh to load.', 'ok');

      if (!('Notification' in window)) return;
      if (Notification.permission !== 'granted') return;

      try {
        new Notification(title, {
          body: message,
          tag: 'fwj-security-incident',
          renotify: true,
        });
      } catch {
        // ignore
      }
    }

    async function pollIncidentNoticeForChanges() {
      try {
        const result = await fetchFirstOkJson(getIncidentApiCandidates(), { cache: 'no-store' });
        if (!result || !result.data) return;

        const data = result.data || {};
        const next = {
          enabled: Boolean(data.enabled),
          updatedAtUtc: (data && typeof data.updatedAtUtc === 'string' && data.updatedAtUtc.trim()) ? data.updatedAtUtc.trim() : null,
          title: (data && typeof data.title === 'string') ? data.title : '',
          message: (data && typeof data.message === 'string') ? data.message : '',
        };

        // Keep the pill in sync without overwriting form edits.
        renderIncidentPill(next.enabled, next.updatedAtUtc);

        const prev = readIncidentWatchState();
        const isFirst = !prev.initialized;

        // Prime state on first successful fetch (no notification on page load).
        if (isFirst) {
          writeIncidentWatchState({ initialized: true, enabled: next.enabled, updatedAtUtc: next.updatedAtUtc });
          return;
        }

        const turnedOn = !prev.enabled && next.enabled;
        const updated = next.enabled && next.updatedAtUtc && prev.updatedAtUtc && next.updatedAtUtc !== prev.updatedAtUtc;
        const updatedWithMissingPrev = next.enabled && next.updatedAtUtc && !prev.updatedAtUtc;
        const turnedOff = prev.enabled && !next.enabled;

        // Notify on: turned on, or changed updatedAtUtc while enabled.
        if (turnedOn || updated || updatedWithMissingPrev) {
          notifyIncidentChange(next, prev);
        } else if (turnedOff) {
          setIncidentStatus('Incident notice disabled on server.', 'ok');
        }

        writeIncidentWatchState({ initialized: true, enabled: next.enabled, updatedAtUtc: next.updatedAtUtc });
      } catch {
        // best-effort
      }
    }

    function startIncidentWatch() {
      if (incidentWatchTimer) return;
      // Initial poll then every 60s (while admin page is open).
      pollIncidentNoticeForChanges();
      incidentWatchTimer = setInterval(pollIncidentNoticeForChanges, 60_000);
    }

    function stopIncidentWatch() {
      if (!incidentWatchTimer) return;
      try { clearInterval(incidentWatchTimer); } catch {}
      incidentWatchTimer = null;
    }

    async function loadIncidentNotice() {
      setIncidentStatus('Loadingâ€¦', null);
      try {
        const result = await fetchFirstOkJson(getIncidentApiCandidates(), { cache: 'no-store' });
        if (!result) throw new Error('No incident API responded.');
        fillIncidentForm(result.data || {});
        setIncidentStatus(`Loaded from ${result.url}`, 'ok');
      } catch (e) {
        console.error(e);
        fillIncidentForm({ enabled: false, title: '', message: '', updatedAtUtc: null });
        setIncidentStatus('Failed to load incident notice.', 'err');
      }
    }

    async function saveIncidentNotice() {
      if (isPreviewMode()) {
        setIncidentStatus('Preview mode: changes are disabled.', 'err');
        return;
      }

      const auth = authHeader;
      if (!auth) {
        setIncidentStatus('Locked. Click Unlock first.', 'err');
        return;
      }

      const enabled = (incidentEnabledEl && incidentEnabledEl.value === '1');
      const title = (incidentTitleEl ? incidentTitleEl.value : '').trim();
      const message = (incidentMessageEl ? incidentMessageEl.value : '').trim();

      if (enabled && (!title || !message)) {
        setIncidentStatus('When enabled, title + message are required.', 'err');
        return;
      }
      if (title.length > 80) {
        setIncidentStatus('Title must be 0-80 characters.', 'err');
        return;
      }
      if (message.length > 220) {
        setIncidentStatus('Message must be 0-220 characters.', 'err');
        return;
      }

      setIncidentStatus('Savingâ€¦', null);
      try {
        const targets = getIncidentApiCandidates();
        let savedUrl = null;
        let lastStatus = null;
        let lastBody = null;
        let lastUrl = null;

        for (const u of targets) {
          try {
            const resp = await fetch(u, {
              method: 'PUT',
              headers: {
                'content-type': 'application/json',
                'authorization': auth,
              },
              body: JSON.stringify({ enabled, title, message }),
            });

            lastUrl = u;
            lastStatus = resp.status;
            if (resp.status === 401) {
              setIncidentStatus('Unauthorized (wrong username/password).', 'err');
              return;
            }
            if (!resp.ok) {
              try { lastBody = await resp.text(); } catch { lastBody = null; }
              continue;
            }

            savedUrl = u;
            break;
          } catch {
            // try next
          }
        }

        if (!savedUrl) {
          const extra = lastBody ? ` â€” ${String(lastBody).slice(0, 220)}` : '';
          const hint = (lastUrl && lastUrl === '/api/incident-notice' && (lastStatus === 404 || lastStatus === 405))
            ? ' Hint: /api/incident-notice is not configured. Ensure your Cloudflare Worker has a route for /api/incident-notice'
            : '';
          throw new Error(`Save failed (last: ${lastUrl || (targets[0] || '/api/incident-notice')} status: ${lastStatus ?? 'n/a'})${extra}${hint}`);
        }

        setIncidentStatus(`Saved to ${savedUrl}.`, 'ok');
        await loadIncidentNotice();
      } catch (e) {
        console.error(e);
        setIncidentStatus(String(e && e.message ? e.message : 'Save failed.'), 'err');
      }
    }


    function setSiteModeStatus(text, kind) {
      if (!siteModeStatusEl) return;
      const cls = 'admin-msg' + (kind ? ` ${kind}` : '');
      siteModeStatusEl.textContent = text || '';
      siteModeStatusEl.className = cls;
    }

    function renderSiteMode(mode, updatedAtUtc) {
      if (!siteModePillEl) return;
      const m = (mode || 'live').toLowerCase();
      const label = m === 'maintenance' ? 'ğŸ”§ Maintenance' : 'âœ… Live';
      const when = updatedAtUtc ? ` (updated ${updatedAtUtc})` : '';
      siteModePillEl.textContent = `Mode: ${label}${when}`;
    }

    async function loadSiteMode() {
      setSiteModeStatus('Loadingâ€¦', null);
      try {
        const result = await fetchFirstOkJson(getSiteModeApiCandidates(), { cache: 'no-store' });
        if (!result) throw new Error('No site-mode API responded.');
        const data = result.data || {};
        renderSiteMode(data.mode || 'live', data.updatedAtUtc || null);
        setSiteModeStatus(`Loaded from ${result.url}`, 'ok');
      } catch (e) {
        console.error(e);
        renderSiteMode('live', null);
        setSiteModeStatus('Failed to load site mode (defaulting to Live).', 'err');
      }
    }

    async function saveSiteMode(mode) {
      if (isPreviewMode()) {
        setSiteModeStatus('Preview mode: changes are disabled.', 'err');
        return;
      }

      const auth = authHeader;
      if (!auth) {
        setSiteModeStatus('Locked. Click Unlock first.', 'err');
        return;
      }

      const m = (mode || '').toLowerCase();
      if (m !== 'live' && m !== 'maintenance') {
        setSiteModeStatus('Invalid mode.', 'err');
        return;
      }

      setSiteModeStatus('Savingâ€¦', null);
      try {
        const targets = getSiteModeApiCandidates();
        let savedUrl = null;
        let lastStatus = null;
        let lastBody = null;
        let lastUrl = null;

        for (const u of targets) {
          try {
            const resp = await fetch(u, {
              method: 'PUT',
              headers: {
                'content-type': 'application/json',
                'authorization': auth,
              },
              body: JSON.stringify({ mode: m }),
            });

            lastUrl = u;
            lastStatus = resp.status;
            if (resp.status === 401) {
              setSiteModeStatus('Unauthorized (wrong username/password).', 'err');
              return;
            }

            if (!resp.ok) {
              try {
                lastBody = await resp.text();
              } catch {
                lastBody = null;
              }
              continue;
            }

            savedUrl = u;
            break;
          } catch {
            // try next
          }
        }

        if (!savedUrl) {
          const extra = lastBody ? ` â€” ${String(lastBody).slice(0, 220)}` : '';
          const hint = (lastUrl && lastUrl === '/api/site-mode' && (lastStatus === 404 || lastStatus === 405))
            ? ' Hint: /api/site-mode is not configured. Ensure your Cloudflare Worker has a route for /api/site-mode* (or pass ?siteModeApi=https://api.flyingwithjoel.co.uk/api/site_mode.php)'
            : '';
          throw new Error(`Save failed (last: ${lastUrl || (targets[0] || '/api/site-mode')} status: ${lastStatus ?? 'n/a'})${extra}${hint}`);
        }

        setSiteModeStatus(`Saved to ${savedUrl}.`, 'ok');
        await loadSiteMode();
      } catch (e) {
        console.error(e);
        setSiteModeStatus(String(e && e.message ? e.message : 'Save failed.'), 'err');
      }
    }

    function isPreviewMode() {
      try {
        return new URLSearchParams(window.location.search).get('preview') === '1';
      } catch {
        return false;
      }
    }

    async function fetchFirstOkJson(urls, init) {
      for (const u of urls) {
        try {
          const resp = await fetch(u, init);
          if (!resp.ok) continue;
          return { url: u, data: await resp.json() };
        } catch {
          // try next
        }
      }
      return null;
    }

    function monthOptionsHtml(selectedIndex) {
      return MONTHS.map((m, idx) => `<option value="${idx + 1}" ${idx === selectedIndex ? 'selected' : ''}>${m}</option>`).join('');
    }

    function statusOptionsHtml(selectedValue) {
      const v = (selectedValue || 'none').toLowerCase();
      return STATUSES.map((s) => `<option value="${s.value}" ${s.value === v ? 'selected' : ''}>${s.label}</option>`).join('');
    }

    function buildEmptySchedule(startOffsetDays = 0) {
      const today = new Date();
      const offset = Number.isFinite(startOffsetDays) ? Math.trunc(startOffsetDays) : 0;
      const items = [];
      for (let i = 0; i < 7; i += 1) {
        // Start from TODAY + offset (e.g., offset=1 => tomorrow)
        const nextDate = new Date(today);
        nextDate.setDate(today.getDate() + offset + i);
        const month = nextDate.getMonth() + 1;
        const day = nextDate.getDate();
        const dayIdx = nextDate.getDay(); // 0=Sun, 1=Mon, ...
        // Map JS dayIdx to DEFAULT_DAYS (which starts with MON)
        // JS: 0=Sun, 1=Mon, ..., 6=Sat
        // DEFAULT_DAYS: 0=MON, ..., 6=SUN
        // So, for Sun (0), want 6; for Mon (1), want 0, etc.
        const defaultDayName = DEFAULT_DAYS[(dayIdx + 6) % 7];
        items.push({
          dateKey: `${month}-${day}`,
          dayName: defaultDayName,
          dateText: `${MONTHS[month - 1]} ${day}`,
          status: 'none',
          gameLogo: '-',
          timeText: 'No Stream Planned',
          zuluTime: null,
          streamTitle: '-',
          vodUrl: null,
        });
      }
      return items;
    }

    function parseDateKey(dateKey) {
      const m = typeof dateKey === 'string' ? dateKey.match(/^(\d{1,2})-(\d{1,2})$/) : null;
      if (!m) return { month: 1, day: 1 };
      return { month: Math.max(1, Math.min(12, parseInt(m[1], 10))), day: Math.max(1, Math.min(31, parseInt(m[2], 10))) };
    }

    const DESKTOP_EDITOR_MQL = window.matchMedia ? window.matchMedia('(min-width: 1100px)') : null;
    let activeDesktopIndex = null;
    let activeDesktopDetailsEl = null;

    function isDesktopLayout() {
      return DESKTOP_EDITOR_MQL ? DESKTOP_EDITOR_MQL.matches : false;
    }

    function clearDesktopSelection() {
      activeDesktopIndex = null;
      if (activeDesktopDetailsEl) {
        const homeIdx = activeDesktopDetailsEl.getAttribute('data-home-index');
        const home = homeIdx != null ? document.querySelector(`.admin-day-card[data-index="${homeIdx}"]`) : null;
        if (home) home.appendChild(activeDesktopDetailsEl);
      }
      activeDesktopDetailsEl = null;
      document.querySelectorAll('.admin-day-card.is-selected').forEach((c) => c.classList.remove('is-selected'));
      if (desktopEditorBodyEl) {
        desktopEditorBodyEl.innerHTML = '<p class="desktop-editor-empty">Pick a day card on the left to load its editor here. This keeps the grid stable while you edit.</p>';
      }
    }

    function selectDayDesktop(index) {
      if (!isDesktopLayout()) return;

      const idx = Math.max(0, Math.min(6, parseInt(String(index), 10)));
      const card = document.querySelector(`.admin-day-card[data-index="${idx}"]`);
      if (!card) return;

      if (activeDesktopDetailsEl && activeDesktopIndex !== null) {
        const prevHome = document.querySelector(`.admin-day-card[data-index="${activeDesktopIndex}"]`);
        if (prevHome) prevHome.appendChild(activeDesktopDetailsEl);
      }

      document.querySelectorAll('.admin-day-card.is-selected').forEach((c) => c.classList.remove('is-selected'));
      card.classList.add('is-selected');

      const details = card.querySelector('details.admin-edit');
      if (!details || !desktopEditorBodyEl) return;
      details.setAttribute('data-home-index', String(idx));
      details.open = true;

      desktopEditorBodyEl.innerHTML = '';
      desktopEditorBodyEl.appendChild(details);

      const dayText = (card.querySelector('.day-name')?.textContent || '').trim();
      const dateText = (card.querySelector('.day-date')?.textContent || '').trim();
      if (desktopEditorTitleEl) desktopEditorTitleEl.textContent = `âœï¸ Edit ${dayText || 'day'}`;
      if (desktopEditorSubEl) desktopEditorSubEl.textContent = dateText || 'â€”';

      activeDesktopIndex = idx;
      activeDesktopDetailsEl = details;
    }

    function renderEditor(items) {
      scheduleGridEl.innerHTML = '';

      // Reset desktop panel when re-rendering
      if (desktopEditorBodyEl) clearDesktopSelection();

      let prevRowEl = null;

      items.slice(0, 7).forEach((item, idx) => {
        const parsed = parseDateKey(item.dateKey);
        const monthIdx = parsed.month - 1;
        const status = (item && item.status ? String(item.status) : 'none').toLowerCase();
        const originalZulu = (item && item.originalZuluTime ? String(item.originalZuluTime) : '');
        const zuluForTimeField = status === 'delayed' ? originalZulu : (item && item.zuluTime ? String(item.zuluTime) : '');
        const zuluForDelayedTo = status === 'delayed' ? (item && item.zuluTime ? String(item.zuluTime) : '') : '';
        const vodUrl = (item && item.vodUrl ? String(item.vodUrl) : '');

        const wrapper = document.createElement('div');
        wrapper.className = 'day-card admin-day-card';
        wrapper.dataset.index = String(idx);

        const pill = document.createElement('span');
        pill.className = 'status-pill none';
        wrapper.appendChild(pill);

        const dayNameEl = document.createElement('div');
        dayNameEl.className = 'day-name';
        wrapper.appendChild(dayNameEl);

        const dateEl = document.createElement('div');
        dateEl.className = 'day-date';
        wrapper.appendChild(dateEl);

        const gameLogoEl = document.createElement('div');
        gameLogoEl.className = 'game-logo';
        wrapper.appendChild(gameLogoEl);

        const timeDisplayEl = document.createElement('div');
        timeDisplayEl.className = 'stream-time';
        wrapper.appendChild(timeDisplayEl);

        const titleDisplayEl = document.createElement('div');
        titleDisplayEl.className = 'stream-title';
        wrapper.appendChild(titleDisplayEl);

        const extraEl = document.createElement('div');
        extraEl.className = 'admin-extra';
        wrapper.appendChild(extraEl);

        const editorDetails = document.createElement('details');
        editorDetails.className = 'admin-edit';
        editorDetails.innerHTML = '<summary>âœï¸ Edit</summary>';

        const editorContent = document.createElement('div');
        editorContent.className = 'admin-edit-content';

        const row = document.createElement('div');
        row.className = 'schedule-item';
        row.dataset.index = String(idx);

        row.innerHTML = `
          <div class="editor-toolbar">
            <div class="status-chips" aria-label="Quick status">
              <button type="button" class="chip" data-set-status="none">No stream</button>
              <button type="button" class="chip" data-set-status="scheduled">Scheduled</button>
              <button type="button" class="chip live" data-set-status="live">Live</button>
              <button type="button" class="chip warn" data-set-status="delayed">Delayed</button>
              <button type="button" class="chip danger" data-set-status="cancelled">Cancelled</button>
              <button type="button" class="chip ok" data-set-status="completed">Completed</button>
            </div>
            <div class="editor-actions">
              <button type="button" class="mini-btn" data-copy-prev ${idx === 0 ? 'disabled' : ''} title="Copy time/title from previous day">â†º Copy prev</button>
              <button type="button" class="mini-btn" data-clear-day title="Set to no stream and clear fields">ğŸ§¹ Clear</button>
            </div>
          </div>

          <div class="field field-day">
            <label>Day</label>
            <input type="text" class="dayName" value="${(item.dayName || DEFAULT_DAYS[idx] || '').replace(/"/g,'&quot;')}" maxlength="5" />
          </div>

          <div class="field field-date">
            <label>Date</label>
            <div class="date-row">
              <select class="month">${monthOptionsHtml(monthIdx)}</select>
              <input type="number" class="day" min="1" max="31" value="${parsed.day}" />
            </div>
            <small class="datePreview"></small>
          </div>

          <div class="field field-time">
            <label>Time (Zulu)</label>
            <input type="text" class="time" placeholder="18:00" value="${(zuluForTimeField || '').replace(/"/g,'&quot;')}" />
          </div>

          <div class="field field-delayed delayedWrap">
            <label>New Time (Zulu)</label>
            <input type="text" class="delayedTo" placeholder="19:30" value="${(zuluForDelayedTo || '').replace(/"/g,'&quot;')}" />
            <small class="delayedHint"></small>
          </div>

          <div class="field field-title">
            <label>Title</label>
            <input type="text" class="title" placeholder="Microsoft Flight Simulator" value="${(item.streamTitle || '').replace(/"/g,'&quot;')}" />

            <div class="vodWrap" style="margin-top: 0.6rem;">
              <label class="vod-label">Twitch VOD link (optional)</label>
              <input type="url" class="vodUrl" placeholder="https://www.twitch.tv/videos/..." value="${(vodUrl || '').replace(/"/g,'&quot;')}" />
              <small class="vodHint"></small>
            </div>
          </div>

          <div class="field field-status">
            <label>Status</label>
            <select class="status">${statusOptionsHtml(status)}</select>
            <small class="streamHint"></small>
          </div>
        `;

        editorContent.appendChild(row);
        editorDetails.appendChild(editorContent);
        wrapper.appendChild(editorDetails);
        scheduleGridEl.appendChild(wrapper);

        // UX: mobile = toggle embedded editor. Desktop = open right-side editor.
        wrapper.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof Element)) return;
          if (target.closest('a, button, input, select, textarea, label')) return;

          if (isDesktopLayout()) {
            selectDayDesktop(idx);
            return;
          }

          if (target.closest('summary')) return;
          if (target.closest('.admin-edit-content')) return;
          const d = wrapper.querySelector('details.admin-edit');
          if (!d) return;
          d.open = !d.open;
        });

        // Initialize previews
        updateRowDerived(row);

        // Initialize summary
        updateSummary(wrapper, row);

        // Initialize quick status UI
        updateQuickStatusUi(row);

        // Wire changes
        row.querySelectorAll('input, select').forEach((el) => {
          el.addEventListener('input', () => {
            updateRowDerived(row);
            updateSummary(wrapper, row);
            updateQuickStatusUi(row);
            syncJsonFromEditor(false);
          });
          el.addEventListener('change', () => {
            updateRowDerived(row);
            updateSummary(wrapper, row);
            updateQuickStatusUi(row);
            syncJsonFromEditor(false);
          });
        });

        // Quick status buttons
        row.querySelectorAll('[data-set-status]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const next = String(btn.getAttribute('data-set-status') || 'none');
            const select = row.querySelector('.status');
            if (!select) return;
            select.value = next;
            updateRowDerived(row);
            updateSummary(wrapper, row);
            updateQuickStatusUi(row);
            syncJsonFromEditor(false);
          });
        });

        // Copy previous convenience
        const copyBtn = row.querySelector('[data-copy-prev]');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            if (!prevRowEl) return;
            const prevTime = (prevRowEl.querySelector('.time')?.value || '').trim();
            const prevTitle = (prevRowEl.querySelector('.title')?.value || '').trim();
            const prevStatus = String(prevRowEl.querySelector('.status')?.value || 'none');

            const timeEl = row.querySelector('.time');
            const titleEl = row.querySelector('.title');
            const statusEl = row.querySelector('.status');
            if (timeEl) timeEl.value = prevTime;
            if (titleEl && prevStatus !== 'none') titleEl.value = prevTitle || 'Stream';

            // If currently no stream, promote to scheduled when copying.
            if (statusEl && String(statusEl.value || 'none') === 'none' && prevStatus !== 'none') {
              statusEl.value = prevStatus;
            }

            updateRowDerived(row);
            updateSummary(wrapper, row);
            updateQuickStatusUi(row);
            syncJsonFromEditor(false);
          });
        }

        // Clear day
        const clearBtn = row.querySelector('[data-clear-day]');
        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            const statusEl = row.querySelector('.status');
            if (statusEl) statusEl.value = 'none';
            updateRowDerived(row);
            updateSummary(wrapper, row);
            updateQuickStatusUi(row);
            syncJsonFromEditor(false);
          });
        }

        prevRowEl = row;
      });

      // Ensure JSON reflects UI
      syncJsonFromEditor(true);
    }

    function statusLabel(status) {
      const s = (status || 'none').toLowerCase();
      if (s === 'scheduled') return 'scheduled';
      if (s === 'live') return 'live';
      if (s === 'cancelled') return 'cancelled';
      if (s === 'delayed') return 'delayed';
      if (s === 'completed') return 'completed';
      return 'none';
    }

    function updateQuickStatusUi(row) {
      const s = statusLabel(row.querySelector('.status')?.value || 'none');
      row.querySelectorAll('[data-set-status]').forEach((btn) => {
        const v = String(btn.getAttribute('data-set-status') || 'none');
        btn.classList.toggle('active', v === s);
      });
    }

    function statusEmoji(status) {
      const s = (status || 'none').toLowerCase();
      if (s === 'scheduled') return 'ğŸ—“ï¸';
      if (s === 'live') return 'ğŸ”´';
      if (s === 'cancelled') return 'âŒ';
      if (s === 'delayed') return 'â³';
      if (s === 'completed') return 'âœ…';
      return 'ğŸš«';
    }

    function updateSummary(wrapper, row) {
      const day = (row.querySelector('.dayName')?.value || '').trim() || (DEFAULT_DAYS[parseInt(row.dataset.index || '0', 10)] || '-');

      const month = parseInt(row.querySelector('.month')?.value || '1', 10);
      const dayNum = parseInt(row.querySelector('.day')?.value || '1', 10);
      const mIdx = Math.max(1, Math.min(12, month)) - 1;
      const d = Math.max(1, Math.min(31, Number.isFinite(dayNum) ? dayNum : 1));
      const dateText = `${MONTHS[mIdx]} ${d}`;

      const status = statusLabel(row.querySelector('.status')?.value || 'none');

      const title = (row.querySelector('.title')?.value || '').trim() || 'â€”';
      const time = (row.querySelector('.time')?.value || '').trim();
      const delayedTo = (row.querySelector('.delayedTo')?.value || '').trim();

      const vodUrl = (row.querySelector('.vodUrl')?.value || '').trim();

      // ...existing code...

      const dayEl = wrapper.querySelector('.day-name');
      const dateEl = wrapper.querySelector('.day-date');
      const pill = wrapper.querySelector('.status-pill');
      const timeEl = wrapper.querySelector('.stream-time');
      const titleEl = wrapper.querySelector('.stream-title');
      const gameEl = wrapper.querySelector('.game-logo');
      const extraEl = wrapper.querySelector('.admin-extra');

      if (dayEl) dayEl.textContent = day;
      if (dateEl) dateEl.textContent = dateText;

      // Card-level classes match the public schedule page
      wrapper.classList.toggle('has-stream', status !== 'none');
      wrapper.classList.toggle('live', status === 'live');
      wrapper.classList.toggle('cancelled', status === 'cancelled');
      wrapper.classList.toggle('delayed', status === 'delayed');
      wrapper.classList.toggle('completed', status === 'completed');

      if (pill) {
        pill.className = `status-pill ${status}`;
        pill.textContent = status === 'none' ? '' : status.toUpperCase();
      }

      if (gameEl) gameEl.textContent = status === 'none' ? '-' : 'âœˆï¸';

      if (timeEl) {
        if (status === 'none') {
          timeEl.textContent = 'No Stream Planned';
          timeEl.removeAttribute('data-zulu-time');
        } else if (status === 'delayed') {
          const to = normalizeZulu(delayedTo);
          timeEl.textContent = to ? `Delayed to ${to}` : 'Delayed (new time TBC)';
          if (to) timeEl.setAttribute('data-zulu-time', to);
          else timeEl.removeAttribute('data-zulu-time');
        } else {
          const t = normalizeZulu(time);
          timeEl.textContent = t || 'TBC';
          if (t) timeEl.setAttribute('data-zulu-time', t);
          else timeEl.removeAttribute('data-zulu-time');
        }
      }

      if (titleEl) {
        titleEl.textContent = status === 'none' ? '-' : (title || 'Stream');
      }

      if (extraEl) {
        extraEl.className = 'admin-extra';
        extraEl.innerHTML = '';
        if (status === 'cancelled') {
          extraEl.classList.add('cancelled');
          extraEl.textContent = 'âœ–ï¸ Cancelled';
        } else if (status === 'completed') {
          if (vodUrl) {
            extraEl.innerHTML = `<a href="${vodUrl.replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer">âœ“ Completed - Watch VOD</a>`;
          } else {
            extraEl.textContent = 'âœ“ Completed';
          }
        } else if (status === 'delayed') {
          extraEl.classList.add('delayed');
          const from = normalizeZulu(time);
          const to = normalizeZulu(delayedTo);
          extraEl.textContent = from && to ? `â³ ${from} â†’ ${to}` : 'â³ Delayed';
        }
      }
    }

    // Keep cards collapsed by default; edit panels are opened manually.
    const DETAILS_DESKTOP_MQL = null;
    let lastDetailsAutoOpen = null;

    function updateRowDerived(row) {
      const month = parseInt(row.querySelector('.month').value, 10);
      const day = parseInt(row.querySelector('.day').value, 10);
      const previewEl = row.querySelector('.datePreview');

      const mIdx = Math.max(1, Math.min(12, month)) - 1;
      const d = Math.max(1, Math.min(31, Number.isFinite(day) ? day : 1));

      previewEl.textContent = `${MONTHS[mIdx]} ${d}`;

      const status = (row.querySelector('.status').value || 'none').toLowerCase();
      const hintEl = row.querySelector('.streamHint');

      const timeEl = row.querySelector('.time');
      const titleEl = row.querySelector('.title');
      const delayedWrap = row.querySelector('.delayedWrap');
      const delayedToEl = row.querySelector('.delayedTo');
      const delayedHintEl = row.querySelector('.delayedHint');

      const vodWrap = row.querySelector('.vodWrap');
      const vodUrlEl = row.querySelector('.vodUrl');
      const vodHintEl = row.querySelector('.vodHint');

      const isNone = status === 'none';
      const isDelayed = status === 'delayed';
      const isCompleted = status === 'completed';

      row.classList.toggle('is-delayed', isDelayed);

      hintEl.textContent = isNone ? 'No stream planned' : `Status: ${status}`;

      // Show/hide delayed UI
      delayedWrap.style.display = isDelayed ? '' : 'none';
      delayedToEl.disabled = !isDelayed ? true : false;
      delayedHintEl.textContent = isDelayed ? 'Enter the delayed (new) start time' : '';

      // Show/hide VOD UI (only meaningful for completed)
      vodWrap.style.display = isCompleted ? '' : 'none';
      vodUrlEl.disabled = !isCompleted;
      vodHintEl.textContent = isCompleted ? 'This will appear on the completed card on the homepage.' : '';

      // UX: disable time/title when no stream
      if (isNone) {
        timeEl.disabled = true;
        titleEl.disabled = true;
        timeEl.value = '';
        titleEl.value = '';
        delayedToEl.value = '';
        vodUrlEl.value = '';
      } else if (isDelayed) {
        // For delayed, allow editing both time and delayedTo
        timeEl.disabled = false;
        titleEl.disabled = false;
        delayedToEl.disabled = false;
      } else {
        timeEl.disabled = false;
        titleEl.disabled = false;
        delayedToEl.disabled = true;
      }
    }

    function scheduleFromEditor() {
      const rows = Array.from(document.querySelectorAll('.schedule-item'));
      return rows.map((row, idx) => {
        const dayName = (row.querySelector('.dayName').value || DEFAULT_DAYS[idx] || '-').trim();
        const month = Math.max(1, Math.min(12, parseInt(row.querySelector('.month').value, 10)));
        const day = Math.max(1, Math.min(31, parseInt(row.querySelector('.day').value, 10)));
        const dateKey = `${month}-${day}`;
        const dateText = `${MONTHS[month - 1]} ${day}`;

        const status = (row.querySelector('.status').value || 'none').toLowerCase();
        const zuluTimeRaw = (row.querySelector('.time').value || '').trim();
        const delayedToRaw = (row.querySelector('.delayedTo').value || '').trim();
        const titleRaw = (row.querySelector('.title').value || '').trim();
        const vodUrlRaw = (row.querySelector('.vodUrl')?.value || '').trim();

        const streamTitle = titleRaw || 'Stream';
        if (status === 'none') {
          return {
            dateKey,
            dayName,
            dateText,
            status: 'none',
            gameLogo: '-',
            timeText: 'No Stream Planned',
            zuluTime: null,
            streamTitle: '-',
            vodUrl: null,
          };
        }
        if (status === 'live') {
          const zuluTime = normalizeZulu(zuluTimeRaw);
          const timeText = zuluTime || 'Live';
          return {
            dateKey,
            dayName,
            dateText,
            status: 'live',
            gameLogo: 'âœˆï¸',
            timeText,
            zuluTime: zuluTime || null,
            streamTitle,
            vodUrl: null,
          };
        }

        if (status === 'completed') {
          const zuluTime = normalizeZulu(zuluTimeRaw);
          const timeText = zuluTime || 'Completed';
          const vodUrl = vodUrlRaw || null;

          return {
            dateKey,
            dayName,
            dateText,
            status: 'completed',
            gameLogo: 'âœˆï¸',
            timeText,
            zuluTime: zuluTime || null,
            streamTitle,
            vodUrl,
          };
        }

        if (status === 'delayed') {
          const originalZuluTime = normalizeZulu(zuluTimeRaw);
          const delayedZuluTime = normalizeZulu(delayedToRaw);
          const timeText = delayedZuluTime ? `Delayed to ${delayedZuluTime}` : 'Delayed (new time TBC)';

          return {
            dateKey,
            dayName,
            dateText,
            status: 'delayed',
            gameLogo: 'âœˆï¸',
            timeText,
            zuluTime: delayedZuluTime || null,
            originalZuluTime: originalZuluTime || null,
            streamTitle,
            vodUrl: null,
          };
        }

        const zuluTime = normalizeZulu(zuluTimeRaw);
        const timeText = zuluTime || (status === 'cancelled' ? 'Cancelled' : 'TBC');

        return {
          dateKey,
          dayName,
          dateText,
          status: status === 'cancelled' ? 'cancelled' : 'scheduled',
          gameLogo: 'âœˆï¸',
          timeText,
          zuluTime: zuluTime || null,
          streamTitle,
          vodUrl: null,
        };
      });
    }

    function syncJsonFromEditor(showStatus) {
      const schedule = scheduleFromEditor();
      jsonEl.value = JSON.stringify(schedule, null, 2);
      updateDiscordMessagePreview();
      if (showStatus) setStatus('Editor synced to JSON.', 'ok');
    }

    function setStatus(text, kind) {
      const cls = 'admin-msg' + (kind ? ` ${kind}` : '');

      if (statusEl) {
        statusEl.textContent = text;
        statusEl.className = cls;
      }
      if (statusBarEl) {
        statusBarEl.textContent = text;
        statusBarEl.className = cls;
      }
    }

    function getAuthHeader() {
      const user = userEl.value || '';
      const pass = passEl.value || '';
      if (!user || !pass) return null;
      return 'Basic ' + btoa(`${user}:${pass}`);
    }

    async function verifyCredentials(auth) {
      // Only supported on the Cloudflare Worker backend.
      const resp = await fetch('/api/schedule/auth', {
        method: 'GET',
        headers: { 'authorization': auth },
        cache: 'no-store',
      });
      if (resp.status === 401) return { ok: false, reason: 'Unauthorized (wrong username/password).' };
      if (!resp.ok) return { ok: false, reason: `Auth check failed (${resp.status}).` };
      return { ok: true };
    }

    function unlockUi() {
      loginCardEl.classList.add('hidden');
      editorCardEl.classList.remove('hidden');
    }

    function lockUi() {
      authHeader = null;
      editorCardEl.classList.add('hidden');
      loginCardEl.classList.remove('hidden');
      setStatus('', null);
      renderSiteMode('live', null);
      setSiteModeStatus('', null);
      try { if (typeof setAdminNotesStatus === 'function') setAdminNotesStatus(''); } catch {}
    }

    async function unlock() {
      const auth = getAuthHeader();
      if (!auth) {
        setStatus('Enter username + password first.', 'err');
        return;
      }
      setStatus('Checking credentialsâ€¦');
      try {
        const result = await verifyCredentials(auth);
        if (!result.ok) {
          setStatus(result.reason || 'Login failed.', 'err');
          return;
        }
        authHeader = auth;
        unlockUi();
        setStatus('Unlocked.', 'ok');
        await loadCurrent();
        await loadSiteMode();
        try { if (typeof loadAdminNotes === 'function') await loadAdminNotes(); } catch {}
        try { if (typeof fetchExpectedReturnMessage === 'function') fetchExpectedReturnMessage(); } catch {}
        try { await loadIncidentNotice(); } catch {}

        // Optional: incident change notifications while admin is open.
        try {
          if (incidentNotifyEl) {
            const enabled = getIncidentNotifyEnabled();
            incidentNotifyEl.checked = enabled;
            if (enabled) {
              ensureIncidentNotificationPermission();
              startIncidentWatch();
            } else {
              stopIncidentWatch();
            }
          }
        } catch {}
      } catch (e) {
        console.error(e);
        setStatus('Login failed (could not reach auth endpoint).', 'err');
      }
    }

    async function loadCurrent() {
      setStatus('Loadingâ€¦');
      try {
        const result = await fetchFirstOkJson(getScheduleApiCandidates(), { cache: 'no-store' });
        if (!result) throw new Error('No schedule API responded.');
        const data = result.data;
        const items = Array.isArray(data) ? data : buildEmptySchedule();
        renderEditor(items);
        setStatus(`Loaded from ${result.url}`, 'ok');
      } catch (e) {
        console.error(e);
        // Fallback: parse whatever schedule is currently on the public schedule page.
        try {
          const fromHome = await loadScheduleFromSchedulePage();
          renderEditor(fromHome);
          setStatus('Loaded from schedule page (fallback).', 'ok');
          return;
        } catch (e2) {
          console.error(e2);
        }

        renderEditor(buildEmptySchedule());
        setStatus('Failed to load schedule (API + schedule-page fallback failed).', 'err');
      }
    }

    async function loadScheduleFromSchedulePage() {
      // Same-origin only; this is a best-effort fallback when /api/schedule isnâ€™t routed.
      const resp = await fetch('/pages/schedule.html', { cache: 'no-store' });
      if (!resp.ok) throw new Error(`Schedule page fetch failed (${resp.status}).`);
      const html = await resp.text();

      const doc = new DOMParser().parseFromString(html, 'text/html');
      const cards = Array.from(doc.querySelectorAll('#weekly-schedule .day-card'));
      if (!cards.length) throw new Error('No schedule cards found on schedule page.');

      const items = cards.slice(0, 7).map((card, idx) => {
        const dateKey = card.getAttribute('data-date') || '1-1';

        const dayName = (card.querySelector('.day-name')?.textContent || DEFAULT_DAYS[idx] || '-').trim();
        const dateText = (card.querySelector('.day-date')?.textContent || card.querySelector('div[style*="font-size: 0.8rem"]')?.textContent || '').trim();

        const gameLogo = (card.querySelector('.game-logo')?.textContent || '-').trim();
        const timeEl = card.querySelector('.stream-time');
        const streamTitle = (card.querySelector('.stream-title')?.textContent || '-').trim();

        const zuluTime = (timeEl?.getAttribute('data-zulu-time') || '').trim() || null;
        const timeText = (timeEl?.textContent || 'No Stream Planned').trim();

        let status = 'none';
        if (card.classList.contains('completed')) status = 'completed';
        else if (card.classList.contains('cancelled')) status = 'cancelled';
        else if (card.classList.contains('delayed')) status = 'delayed';
        else if (card.classList.contains('has-stream')) status = 'scheduled';

        let vodUrl = null;
        if (status === 'completed') {
          const a = card.querySelector('a[href]');
          if (a) vodUrl = a.getAttribute('href');
        }

        if (status === 'none') {
          return {
            dateKey,
            dayName,
            dateText,
            status: 'none',
            gameLogo: '-',
            timeText: 'No Stream Planned',
            zuluTime: null,
            streamTitle: '-',
            vodUrl: null,
          };
        }

        return {
          dateKey,
          dayName,
          dateText,
          status,
          gameLogo: gameLogo || 'âœˆï¸',
          timeText,
          zuluTime,
          streamTitle,
          vodUrl: vodUrl || null,
        };
      });

      return items;
    }

    function formatJson() {
      syncJsonFromEditor(true);
    }

    async function saveSchedule() {
      if (isPreviewMode()) {
        setStatus('Preview mode: saving is disabled.', 'err');
        return;
      }
      const auth = authHeader;
      if (!auth) {
        setStatus('Locked. Click Unlock first.', 'err');
        return;
      }

      // Validation: For any delayed status, require a new time
      const rows = Array.from(document.querySelectorAll('.schedule-item'));
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const status = (row.querySelector('.status').value || 'none').toLowerCase();
        if (status === 'delayed') {
          const delayedTo = (row.querySelector('.delayedTo').value || '').trim();
          if (!delayedTo) {
            setStatus(`Error: For delayed status, you must enter a new time (Zulu) for day ${i + 1}.`, 'err');
            row.querySelector('.delayedTo').focus();
            return;
          }
        }
      }

      const parsed = scheduleFromEditor();
      jsonEl.value = JSON.stringify(parsed, null, 2);

      setStatus('Savingâ€¦');
      try {
        const targets = getScheduleApiCandidates();
        let savedUrl = null;
        let lastStatus = null;
        let lastBody = null;
        let lastDetails = null;

        for (const u of targets) {
          try {
            const resp = await fetch(u, {
              method: 'PUT',
              headers: {
                'content-type': 'application/json',
                'authorization': auth,
              },
              body: JSON.stringify(parsed),
            });

            lastStatus = resp.status;
            if (resp.status === 401) {
              setStatus('Unauthorized (wrong username/password).', 'err');
              return;
            }

            if (!resp.ok) {
              try {
                const ct = (resp.headers.get('content-type') || '').toLowerCase();
                if (ct.includes('application/json')) {
                  const j = await resp.json();
                  lastBody = JSON.stringify(j);
                  lastDetails = j && (j.details || j.error || null);
                } else {
                  lastBody = await resp.text();
                }
              } catch {
                lastBody = null;
                lastDetails = null;
              }
              continue;
            }
            savedUrl = u;
            break;
          } catch {
            // try next
          }
        }

        if (!savedUrl) {
          const extra = lastBody ? ` â€” ${String(lastBody).slice(0, 220)}` : '';
          const hint = lastDetails ? ` (details: ${String(lastDetails).slice(0, 220)})` : '';
          throw new Error(`Save failed to ${targets[0] || '/api/schedule'} (last status: ${lastStatus ?? 'n/a'})${extra}${hint}`);
        }

        setStatus(`Saved to ${savedUrl}. Homepage will update once it can fetch the API.`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus(String(e && e.message ? e.message : 'Save failed.'), 'err');
      }
    }

    document.getElementById('btn-unlock').addEventListener('click', unlock);
    document.getElementById('btn-load').addEventListener('click', loadCurrent);
    document.getElementById('btn-format').addEventListener('click', formatJson);
    document.getElementById('btn-save').addEventListener('click', saveSchedule);
    document.getElementById('btn-lock').addEventListener('click', lockUi);

    if (btnIncidentRefreshEl) btnIncidentRefreshEl.addEventListener('click', loadIncidentNotice);
    if (btnIncidentSaveEl) btnIncidentSaveEl.addEventListener('click', saveIncidentNotice);

    if (incidentNotifyEl) {
      // Reflect stored preference immediately (even before unlock).
      incidentNotifyEl.checked = getIncidentNotifyEnabled();
      incidentNotifyEl.addEventListener('change', async () => {
        const enabled = Boolean(incidentNotifyEl.checked);
        setIncidentNotifyEnabled(enabled);
        if (enabled) {
          const ok = await ensureIncidentNotificationPermission();
          if (!ok) {
            setIncidentStatus('Browser notifications blocked. Allow notifications for this site to enable.', 'err');
            return;
          }
          startIncidentWatch();
          setIncidentStatus('Notifications enabled (while this tab is open).', 'ok');
        } else {
          stopIncidentWatch();
          setIncidentStatus('Notifications disabled.', null);
        }
      });
    }

    const expandAllBtn = document.getElementById('btn-expand-all');
    const collapseAllBtn = document.getElementById('btn-collapse-all');
    if (expandAllBtn) {
      expandAllBtn.addEventListener('click', () => {
        document.querySelectorAll('details.admin-edit').forEach((d) => { d.open = true; });
      });
    }
    if (collapseAllBtn) {
      collapseAllBtn.addEventListener('click', () => {
        document.querySelectorAll('details.admin-edit').forEach((d) => { d.open = false; });
      });
    }

    if (btnEditorPrevEl) {
      btnEditorPrevEl.addEventListener('click', () => {
        if (!isDesktopLayout()) return;
        const next = activeDesktopIndex == null ? 0 : (activeDesktopIndex + 6) % 7;
        selectDayDesktop(next);
      });
    }
    if (btnEditorNextEl) {
      btnEditorNextEl.addEventListener('click', () => {
        if (!isDesktopLayout()) return;
        const next = activeDesktopIndex == null ? 0 : (activeDesktopIndex + 1) % 7;
        selectDayDesktop(next);
      });
    }
    if (btnEditorCloseEl) {
      btnEditorCloseEl.addEventListener('click', () => {
        if (!isDesktopLayout()) return;
        clearDesktopSelection();
      });
    }

    if (DESKTOP_EDITOR_MQL) {
      // When switching between desktop/mobile, ensure editors return to their cards.
      const onLayoutChange = () => {
        if (!isDesktopLayout()) {
          // Move any active editor back into its card.
          if (activeDesktopDetailsEl) {
            const homeIdx = activeDesktopDetailsEl.getAttribute('data-home-index');
            const home = homeIdx != null ? document.querySelector(`.admin-day-card[data-index="${homeIdx}"]`) : null;
            if (home) home.appendChild(activeDesktopDetailsEl);
          }
          activeDesktopIndex = null;
          activeDesktopDetailsEl = null;
          document.querySelectorAll('.admin-day-card.is-selected').forEach((c) => c.classList.remove('is-selected'));
          if (desktopEditorBodyEl) {
            desktopEditorBodyEl.innerHTML = '<p class="desktop-editor-empty">Pick a day card on the left to load its editor here. This keeps the grid stable while you edit.</p>';
          }
          if (desktopEditorTitleEl) desktopEditorTitleEl.textContent = 'âœï¸ Edit day';
          if (desktopEditorSubEl) desktopEditorSubEl.textContent = 'Select a day card to edit.';
        }
      };

      if (typeof DESKTOP_EDITOR_MQL.addEventListener === 'function') {
        DESKTOP_EDITOR_MQL.addEventListener('change', onLayoutChange);
      } else if (typeof DESKTOP_EDITOR_MQL.addListener === 'function') {
        DESKTOP_EDITOR_MQL.addListener(onLayoutChange);
      }
    }

    if (btnSiteRefreshEl) btnSiteRefreshEl.addEventListener('click', loadSiteMode);
    if (btnSiteLiveEl) btnSiteLiveEl.addEventListener('click', () => saveSiteMode('live'));
    if (btnSiteMaintEl) btnSiteMaintEl.addEventListener('click', () => saveSiteMode('maintenance'));

    // Default locked view
    if (isPreviewMode()) {
      authHeader = null;
      loginCardEl.classList.add('hidden');
      editorCardEl.classList.remove('hidden');

      const saveBtn = document.getElementById('btn-save');
      const lockBtn = document.getElementById('btn-lock');
      if (saveBtn) saveBtn.disabled = true;
      if (lockBtn) lockBtn.classList.add('hidden');
      if (signedInPillEl) signedInPillEl.textContent = 'Preview mode (cannot save).';

      setStatus('Preview mode enabled.', 'ok');
      loadCurrent();
      loadSiteMode();
    } else {
      lockUi();
    }

  </script>
</body>
</html>
