<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Request My Data / Deletion - Flying With Joel</title>
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <script src="../assets/js/site-mode.js"></script>
  <style>
    .wrap { max-width: 980px; margin: 3rem auto; padding: 0 1.25rem; }
    .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255, 102, 0, 0.2); border-radius: 0.8rem; padding: 1.5rem; }
    .muted { color: var(--text-muted); }
    .field { margin-top: 1rem; }
    label { display:block; margin-bottom: 0.35rem; font-weight: 800; }
    input[type="email"] { width: 100%; max-width: 520px; padding: 0.7rem 0.85rem; border-radius: 0.6rem; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.18); color: var(--text); outline: none; }
    input[type="email"]:focus { border-color: rgba(255, 102, 0, 0.5); }
    .actions { margin-top: 1rem; display:flex; flex-wrap: wrap; gap: 0.6rem; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); color: var(--text); border-radius: 999px; padding: 0.6rem 0.95rem; font-weight: 900; cursor: pointer; }
    .btn.primary { border-color: rgba(255, 102, 0, 0.5); background: rgba(255, 102, 0, 0.12); color: var(--primary); }
    .btn.danger { border-color: rgba(255,68,68,0.55); background: rgba(255,68,68,0.12); color: #FFB3B3; }
    .hint { margin-top: 0.75rem; }
    .status { margin-top: 0.85rem; font-weight: 800; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">flywithjoel</div>
      <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
      <ul class="nav-links" id="nav-links">
        <li><a href="../index.html">Home</a></li>
        <li><a href="schedule.html">Schedule</a></li>
        <li><a href="suggestions.html">Suggestions</a></li>
        <li><a href="privacy.html">Privacy</a></li>
        <li><a href="security.html">Security</a></li>
        <li><a href="#" id="cookie-settings-link">Cookie Settings</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 0.5rem 0; color: var(--primary);">Request My Data / Deletion</h1>
      <p class="muted" style="margin:0 0 1rem 0; line-height:1.6;">Submit a request using the email address you want the confirmation link sent to.</p>

      <div class="field">
        <label for="email">Email address</label>
        <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" />
      </div>

      <div class="actions">
        <button class="btn primary" id="btn-access" type="button">Email my data</button>
        <button class="btn danger" id="btn-delete" type="button">Delete my data</button>
        <a class="btn" href="privacy.html" style="text-decoration:none; display:inline-flex; align-items:center;">Privacy policy</a>
      </div>

      <div class="hint muted">Weâ€™ll email a confirmation link first (to verify you control the address).</div>
      <div class="status" id="status" aria-live="polite"></div>
    </div>
  </div>

  <!-- Cookie Consent Banner -->
  <div id="cookie-consent-banner" class="cookie-consent-banner">
    <div class="cookie-consent-content">
      <p>We use local storage (localStorage) to remember your choices (such as your consent preference for optional third-party embeds/resources). <a href="privacy.html">Learn more about our privacy practices</a>.</p>
    </div>
    <div class="cookie-consent-buttons">
      <button id="cookie-accept-btn" class="cookie-consent-btn accept">Accept</button>
      <button id="cookie-reject-btn" class="cookie-consent-btn decline">Decline</button>
    </div>
  </div>

  <script>
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('nav-links');
    hamburger?.addEventListener('click', () => { hamburger.classList.toggle('active'); navLinks.classList.toggle('active'); });

    const emailEl = document.getElementById('email');
    const statusEl = document.getElementById('status');
    const btnAccess = document.getElementById('btn-access');
    const btnDelete = document.getElementById('btn-delete');

    function setStatus(text) {
      if (statusEl) statusEl.textContent = text || '';
    }

    function setDisabled(disabled) {
      [btnAccess, btnDelete].forEach((b) => { try { if (b) b.disabled = disabled; } catch {} });
    }

    function disableFor(seconds) {
      const s = Number.isFinite(seconds) ? Math.max(1, Math.min(600, Math.trunc(seconds))) : null;
      if (!s) return;
      let remaining = s;
      setDisabled(true);
      setStatus(`Too many requests. Please wait ${remaining}s.`);
      const timer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(timer);
          setDisabled(false);
          setStatus('');
          return;
        }
        setStatus(`Too many requests. Please wait ${remaining}s.`);
      }, 1000);
    }

    async function submit(action) {
      const email = (emailEl && typeof emailEl.value === 'string' ? emailEl.value : '').trim();
      setStatus('');
      if (!email) {
        setStatus('Enter your email address first.');
        emailEl?.focus();
        return;
      }

      setDisabled(true);
      try {
        const resp = await fetch('/api/data-requests', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ email, action })
        });

        const json = await resp.json().catch(() => null);

        if (resp.ok) {
          setStatus((json && json.message) ? json.message : 'Check your inbox for the confirmation link.');
          return;
        }

        if (resp.status === 429) {
          const hdr = resp.headers ? resp.headers.get('retry-after') : null;
          const fromHdr = hdr ? parseInt(hdr, 10) : NaN;
          const fromJson = (json && typeof json.retryAfterSeconds === 'number') ? json.retryAfterSeconds : NaN;
          const seconds = Number.isFinite(fromJson) ? fromJson : (Number.isFinite(fromHdr) ? fromHdr : 120);
          disableFor(seconds);
          return;
        }

        setStatus((json && json.error) ? json.error : 'Request failed. Please try again.');
      } catch {
        setStatus('Request failed. Please try again.');
      } finally {
        // Re-enable unless rate limit handler is active.
        if ((btnAccess && btnAccess.disabled) || (btnDelete && btnDelete.disabled)) {
          // If disableFor() ran, it will manage re-enabling.
          // Otherwise, re-enable now.
          const t = (statusEl && typeof statusEl.textContent === 'string') ? statusEl.textContent : '';
          if (!t.startsWith('Too many requests.')) setDisabled(false);
        } else {
          setDisabled(false);
        }
      }
    }

    btnAccess?.addEventListener('click', () => submit('access'));
    btnDelete?.addEventListener('click', () => submit('delete'));
  </script>

  <script src="../assets/js/main.js"></script>
</body>
</html>
