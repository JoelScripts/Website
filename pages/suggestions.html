<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions - Flying With Joel</title>
    <meta name="description" content="Submit stream ideas and suggestions for Flying With Joel.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://flyingwithjoel.co.uk/pages/suggestions">
    <meta property="og:title" content="Suggestions - Flying With Joel">
    <meta property="og:description" content="Submit stream ideas and suggestions for Flying With Joel.">
    <meta property="og:image" content="https://flyingwithjoel.co.uk/assets/hero-plane.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://flyingwithjoel.co.uk/pages/suggestions">
    <meta name="twitter:title" content="Suggestions - Flying With Joel">
    <meta name="twitter:description" content="Submit stream ideas and suggestions for Flying With Joel.">
    <meta name="twitter:image" content="https://flyingwithjoel.co.uk/assets/hero-plane.jpg">
    <meta name="fwj-suggestions-endpoint" content="https://sweet-sky-cbc4.joelgibson12342.workers.dev/api/suggestions">
    <!-- Optional Turnstile: add <meta name="fwj-turnstile-sitekey" content="YOUR_TURNSTILE_SITE_KEY"> to enable bot protection -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .suggestions-container {
            max-width: 800px;
            margin: 3rem auto;
            padding: 2rem;
        }

        .suggestions-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .suggestions-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .suggestions-header p {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.6;
        }

        .suggestion-form {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 0.6rem;
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background-color: #0a0a0a;
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 0.75rem;
            border-radius: 0.4rem;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255, 140, 66, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        .submit-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 0.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
        }

        .submit-btn:hover {
            transform: scale(1.02);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .success-message {
            display: none;
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 0.4rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #66BB6A;
            text-align: center;
            font-weight: 600;
        }

        .error-message {
            display: none;
            background-color: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            border-radius: 0.4rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #ff6666;
            text-align: center;
            font-weight: 600;
        }

        .required {
            color: var(--secondary);
        }

        @media (max-width: 768px) {
            .suggestions-container {
                padding: 1rem;
            }

            .suggestions-header h1 {
                font-size: 1.8rem;
            }

            .suggestion-form {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar navbar--v2">
    <script src="../assets/js/site-mode.js"></script>
        <div class="nav-container">
            <div class="logo">flywithjoel</div>
            <button class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links" id="nav-links">
                <li><a href="../index.html"><span class="nav-icon" aria-hidden="true">üè†</span>Home</a></li>
                <li><a href="schedule.html"><span class="nav-icon" aria-hidden="true">üìÖ</span>Schedule</a></li>
                <li><a href="../index.html#highlights"><span class="nav-icon" aria-hidden="true">‚ú®</span>Highlights</a></li>
                <li><a href="../index.html#faq"><span class="nav-icon" aria-hidden="true">‚ùì</span>FAQ</a></li>
                <li><a href="../index.html#affiliates"><span class="nav-icon" aria-hidden="true">ü§ù</span>Affiliates</a></li>
                <li><a href="../index.html#contact"><span class="nav-icon" aria-hidden="true">‚úâÔ∏è</span>Contact Me</a></li>
                <li><a href="privacy.html"><span class="nav-icon" aria-hidden="true">üîê</span>Privacy</a></li>
                <li><a href="terms.html"><span class="nav-icon" aria-hidden="true">üìú</span>Terms</a></li>
                <li><a href="suggestions.html" style="color: var(--primary); font-weight: 600;"><span class="nav-icon" aria-hidden="true">üí°</span>Suggestions</a></li>
                <li><a href="https://www.twitch.tv/Flyingwithjoel" target="_blank" class="follow-btn"><span class="nav-icon" aria-hidden="true">‚ñ∂Ô∏è</span>Follow Me</a></li>
            </ul>
        </div>
    </nav>

    <!-- Suggestions Section -->
    <section class="suggestions-container">
        <div class="suggestions-header">
            <h1>‚úàÔ∏è Flight Suggestions</h1>
            <p>Have an idea for an amazing flight route or scenario? I'd love to hear it! Share your suggestions below and I might feature them in an upcoming stream.</p>
        </div>

        <div class="suggestion-form">
            <div class="success-message" id="successMessage">
                ‚úì Thank you! Your suggestion has been submitted successfully!
            </div>
            <div class="error-message" id="errorMessage">
                ‚úó Oops! Something went wrong. Please try again.
            </div>

            <!-- GDPR Privacy Notice -->
            <div style="background: rgba(0, 102, 255, 0.08); border: 1px solid rgba(0, 102, 255, 0.2); border-left: 4px solid #0066ff; padding: 1rem; border-radius: 0.4rem; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #b0b0b0; font-size: 0.9rem;">
                    <strong>Privacy Notice:</strong> Your suggestion data (name, Twitch handle if provided, and flight details) is submitted to us via a secure submission endpoint and delivered to Discord for our review. We use this information solely to process your suggestion and contact you if needed. For details, see our <a href="privacy.html" style="color: #0066ff; text-decoration: none; font-weight: 600;">Privacy Policy</a> and <a href="cookies.html" style="color: #0066ff; text-decoration: none; font-weight: 600;">Cookie Policy</a>.
                </p>
            </div>

            <form id="suggestionForm">
                <!-- Anti-spam honeypot (should remain empty) -->
                <div style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
                    <label for="website">Website</label>
                    <input type="text" id="website" name="website" autocomplete="off" tabindex="-1">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="flightDate">Date of Flight</label>
                        <input type="date" id="flightDate" name="flightDate">
                    </div>
                    <div class="form-group">
                        <label for="flightNumber">Flight Number <span class="required">*</span></label>
                        <input type="text" id="flightNumber" name="flightNumber" placeholder="e.g., VS73" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="callsign">Callsign <span class="required">*</span></label>
                        <input type="text" id="callsign" name="callsign" placeholder="e.g., VIR73Q" required>
                    </div>
                    <div class="form-group">
                        <label for="aircraft">Aircraft Used <span class="required">*</span></label>
                        <input type="text" id="aircraft" name="aircraft" placeholder="e.g., A359" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="departure">Departure Airport <span class="required">*</span></label>
                        <input type="text" id="departure" name="departure" placeholder="e.g., Manchester" required>
                    </div>
                    <div class="form-group">
                        <label for="arrival">Arrival Airport <span class="required">*</span></label>
                        <input type="text" id="arrival" name="arrival" placeholder="e.g., Orlando" required>
                    </div>
                </div>

                <div class="form-group full">
                    <label for="route">Route (IATA Codes) <span class="required">*</span></label>
                    <input type="text" id="route" name="route" placeholder="e.g., MAN - MCO" required>
                </div>

                <div class="form-group full">
                    <label for="flightRadarLink">Link to Flight (FlightRadar24 Link)</label>
                    <input type="url" id="flightRadarLink" name="flightRadarLink" placeholder="https://flightradar24.com/...">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="flightTime">Flight Time <span class="required">*</span></label>
                        <input type="text" id="flightTime" name="flightTime" placeholder="e.g., 8 hours" required>
                    </div>
                    <div class="form-group">
                        <label for="flightLength">Flight Length <span class="required">*</span></label>
                        <select id="flightLength" name="flightLength" required>
                            <option value="">-- Select flight length --</option>
                            <option value="Short Haul">Short Haul</option>
                            <option value="Medium Haul 4+Hours">Medium Haul (4+ Hours)</option>
                            <option value="Long Haul 7+Hours">Long Haul (7+ Hours)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Your Name <span class="required">*</span></label>
                        <input type="text" id="name" name="name" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="twitchHandle">Your Twitch Handle</label>
                        <input type="text" id="twitchHandle" name="twitchHandle" placeholder="YourTwitchName">
                    </div>
                </div>

                <div class="form-group full" style="margin-top: 0.5rem;">
                    <label style="font-weight: 500; color: var(--text-muted); display: flex; gap: 0.7rem; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="suggestionsConsent" name="suggestionsConsent" required style="margin-top: 0.25rem;">
                        <span style="line-height: 1.5;">
                            I understand and consent that the information I submit will be sent to Discord for review, and may be processed/stored by Discord as a third-party service. I can request deletion via the contact details in the Privacy Policy.
                        </span>
                    </label>
                </div>

                <!-- Optional Turnstile (shown only if fwj-turnstile-sitekey meta is set) -->
                <div id="turnstileRow" class="form-group full" style="display: none; margin-top: 0.75rem;">
                    <div id="turnstileContainer"></div>
                    <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">
                        This verification helps protect the Suggestions form from automated spam.
                    </div>
                </div>

                <button type="submit" class="submit-btn">Submit Flight Suggestion</button>
            </form>
        </div>
    </section>

    <script>
        // Hamburger Menu Toggle
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('nav-links');

        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navLinks.classList.toggle('active');
        });

        // Close menu when a link is clicked
        const navItems = navLinks.querySelectorAll('a');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                hamburger.classList.remove('active');
                navLinks.classList.remove('active');
            });
        });

        // Form submission
        const form = document.getElementById('suggestionForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const turnstileRow = document.getElementById('turnstileRow');
        const turnstileContainer = document.getElementById('turnstileContainer');

        let turnstileWidgetId = null;
        let turnstileToken = '';

        const SUGGESTIONS_API_CANDIDATES = [
            '/api/suggestions',
            '/api/suggestions.php',
            'https://api.flyingwithjoel.co.uk/api/suggestions',
            'https://api.flyingwithjoel.co.uk/api/suggestions.php',
        ];

        const SUGGESTIONS_API_LOCALSTORAGE_KEY = 'fwj_suggestions_api';

        const ALLOWED_SUGGESTIONS_API_ORIGINS = new Set([
            window.location.origin,
            'https://flyingwithjoel.co.uk',
            'https://www.flyingwithjoel.co.uk',
            'https://api.flyingwithjoel.co.uk',
        ]);

        function getTurnstileSiteKey() {
            return (document.querySelector('meta[name="fwj-turnstile-sitekey"]')?.getAttribute('content') || '').trim();
        }

        function loadTurnstileScript() {
            return new Promise((resolve, reject) => {
                if (window.turnstile) {
                    resolve();
                    return;
                }

                const existing = document.querySelector('script[data-fwj-turnstile="1"]');
                if (existing) {
                    const start = Date.now();
                    const tick = () => {
                        if (window.turnstile) return resolve();
                        if (Date.now() - start > 8000) return reject(new Error('Turnstile failed to load.'));
                        setTimeout(tick, 100);
                    };
                    tick();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
                script.async = true;
                script.defer = true;
                script.setAttribute('data-fwj-turnstile', '1');
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Turnstile script failed to load.'));
                document.head.appendChild(script);
            });
        }

        async function initTurnstileIfConfigured() {
            const siteKey = getTurnstileSiteKey();
            if (!siteKey || !turnstileRow || !turnstileContainer) return;

            turnstileRow.style.display = 'block';
            try {
                await loadTurnstileScript();
                if (!window.turnstile) throw new Error('Turnstile is unavailable.');

                turnstileWidgetId = window.turnstile.render(turnstileContainer, {
                    sitekey: siteKey,
                    callback: (token) => {
                        turnstileToken = String(token || '');
                    },
                    'expired-callback': () => {
                        turnstileToken = '';
                    },
                    'error-callback': () => {
                        turnstileToken = '';
                    }
                });
            } catch (err) {
                console.warn('Turnstile init failed:', err);
                // If Turnstile is configured but cannot load, keep row visible so users understand why submission may be blocked.
            }
        }

        function showFormError(message) {
            successMessage.style.display = 'none';
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '‚úó Oops! Something went wrong. Please try again.';
            }, 6000);
        }

        function normalizeText(value) {
            return (value || '').trim();
        }

        function validateSuggestionForm() {
            // Honeypot
            const honeypot = document.getElementById('website');
            if (honeypot && normalizeText(honeypot.value) !== '') {
                return '‚úó Submission blocked.';
            }

            // Rate-limit (client-side only)
            const now = Date.now();
            const last = parseInt(localStorage.getItem('fwj-suggestions-last-submit') || '0', 10);
            const cooldownMs = 60_000;
            if (last && (now - last) < cooldownMs) {
                const seconds = Math.ceil((cooldownMs - (now - last)) / 1000);
                return `‚úó Please wait ${seconds}s before submitting again.`;
            }

            const consentCheckbox = document.getElementById('suggestionsConsent');
            if (consentCheckbox && !consentCheckbox.checked) {
                return '‚úó Please confirm the privacy consent checkbox before submitting.';
            }

            const siteKey = getTurnstileSiteKey();
            if (siteKey) {
                if (!turnstileToken) {
                    return '‚úó Please complete the verification check before submitting.';
                }
            }

            const flightNumber = normalizeText(document.getElementById('flightNumber').value).toUpperCase();
            const callsign = normalizeText(document.getElementById('callsign').value).toUpperCase();
            const aircraft = normalizeText(document.getElementById('aircraft').value);
            const departure = normalizeText(document.getElementById('departure').value).toUpperCase();
            const arrival = normalizeText(document.getElementById('arrival').value).toUpperCase();
            const route = normalizeText(document.getElementById('route').value).toUpperCase();
            const flightRadarLink = normalizeText(document.getElementById('flightRadarLink').value);
            const flightTime = normalizeText(document.getElementById('flightTime').value);
            const flightLength = normalizeText(document.getElementById('flightLength').value);
            const name = normalizeText(document.getElementById('name').value);
            const twitchHandle = normalizeText(document.getElementById('twitchHandle').value);

            if (name.length < 2 || name.length > 60) return '‚úó Name must be 2‚Äì60 characters.';
            if (flightNumber.length < 2 || flightNumber.length > 8) return '‚úó Flight Number must be 2‚Äì8 characters.';
            if (callsign.length < 3 || callsign.length > 10) return '‚úó Callsign must be 3‚Äì10 characters.';
            if (aircraft.length < 2 || aircraft.length > 20) return '‚úó Aircraft must be 2‚Äì20 characters.';
            if (departure.length < 3 || departure.length > 30) return '‚úó Departure must be 3‚Äì30 characters.';
            if (arrival.length < 3 || arrival.length > 30) return '‚úó Arrival must be 3‚Äì30 characters.';
            if (route.length < 7 || route.length > 30) return '‚úó Route must be 7‚Äì30 characters (e.g., MAN - MCO).';
            if (flightTime.length < 2 || flightTime.length > 30) return '‚úó Flight Time looks invalid.';
            if (!flightLength) return '‚úó Please select a Flight Length.';

            if (!/^[A-Z0-9]{2,8}$/.test(flightNumber)) return '‚úó Flight Number must be letters/numbers only (e.g., VS73).';
            if (!/^[A-Z0-9]{3,10}$/.test(callsign)) return '‚úó Callsign must be letters/numbers only (e.g., VIR73Q).';
            if (!/^[A-Za-z0-9][A-Za-z0-9 \-\/]{1,19}$/.test(aircraft)) return '‚úó Aircraft contains invalid characters.';

            const airportCodeOk = (text) => /^[A-Z]{3,4}$/.test(text) || /^[A-Z0-9 .\-]{3,30}$/.test(text);
            if (!airportCodeOk(departure)) return '‚úó Departure looks invalid (use airport code or name).';
            if (!airportCodeOk(arrival)) return '‚úó Arrival looks invalid (use airport code or name).';

            const routeOk = /^([A-Z]{3,4})\s*-\s*([A-Z]{3,4})(\s*-\s*([A-Z]{3,4}))*$/.test(route);
            if (!routeOk) return '‚úó Route must be airport codes like ‚ÄúMAN - MCO‚Äù (optional extra legs).';

            if (!/\d/.test(flightTime)) return '‚úó Flight Time must include a number (e.g., ‚Äú8h‚Äù, ‚Äú8 hours‚Äù).';

            if (twitchHandle) {
                const cleaned = twitchHandle.startsWith('@') ? twitchHandle.slice(1) : twitchHandle;
                if (!/^[A-Za-z0-9_]{3,25}$/.test(cleaned)) return '‚úó Twitch handle looks invalid.';
            }

            if (flightRadarLink) {
                try {
                    const url = new URL(flightRadarLink);
                    if (url.protocol !== 'https:') return '‚úó FlightRadar24 link must start with https://';
                    if (!url.hostname.toLowerCase().includes('flightradar24.com')) return '‚úó Please use a FlightRadar24 link (flightradar24.com).';
                } catch {
                    return '‚úó FlightRadar24 link is not a valid URL.';
                }
            }

            return null;
        }

        function sanitizeSuggestionApiUrl(raw) {
            const value = (raw || '').trim();
            if (!value) return null;

            if (value.startsWith('/')) {
                if (!value.startsWith('/api/')) return null;
                return value;
            }

            try {
                const url = new URL(value);
                if (url.protocol !== 'https:') return null;
                const isAllowedOrigin = ALLOWED_SUGGESTIONS_API_ORIGINS.has(url.origin);
                const isWorkersDevHost = /\.workers\.dev$/i.test(url.hostname || '');
                if (!isAllowedOrigin && !isWorkersDevHost) return null;

                // Convenience: if a workers.dev URL is provided without a path,
                // normalize it to the expected endpoint.
                if (isWorkersDevHost && (!url.pathname || url.pathname === '/')) {
                    url.pathname = '/api/suggestions';
                }

                // Convenience: if a known API origin is provided without a path,
                // normalize it to the default suggestions endpoint.
                if (isAllowedOrigin && (!url.pathname || url.pathname === '/')) {
                    url.pathname = '/api/suggestions';
                }

                if (!url.pathname.startsWith('/api/')) return null;
                url.hash = '';
                return url.toString();
            } catch {
                return null;
            }
        }

        function getSuggestionsApiOverride() {
            try {
                const params = new URLSearchParams(window.location.search);
                const qp = sanitizeSuggestionApiUrl(params.get('suggestionsApi'));
                if (qp) {
                    localStorage.setItem(SUGGESTIONS_API_LOCALSTORAGE_KEY, qp);
                    return qp;
                }
            } catch {
                // ignore
            }

            try {
                const fromLs = sanitizeSuggestionApiUrl(localStorage.getItem(SUGGESTIONS_API_LOCALSTORAGE_KEY));
                if (fromLs) return fromLs;
            } catch {
                // ignore
            }

            const fromMeta = sanitizeSuggestionApiUrl(
                document.querySelector('meta[name="fwj-suggestions-endpoint"]')?.getAttribute('content') || ''
            );

            return fromMeta;
        }

        function getSuggestionEndpointCandidates() {
            const override = getSuggestionsApiOverride();
            const all = [override, ...SUGGESTIONS_API_CANDIDATES].filter(Boolean);
            return Array.from(new Set(all));
        }

        let lastSuggestionSubmitDiagnostics = [];

        async function postSuggestion(formData) {
            const endpoints = getSuggestionEndpointCandidates();
            let lastResponse = null;
            lastSuggestionSubmitDiagnostics = [];

            for (let i = 0; i < endpoints.length; i += 1) {
                const endpoint = endpoints[i];
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        return response;
                    }

                    lastSuggestionSubmitDiagnostics.push({
                        endpoint,
                        status: response.status,
                        kind: 'http',
                    });

                    lastResponse = response;

                    const canRetry = response.status === 404 || response.status === 405;
                    const hasMoreCandidates = i < endpoints.length - 1;
                    if (canRetry && hasMoreCandidates) {
                        continue;
                    }

                    return response;
                } catch {
                    lastSuggestionSubmitDiagnostics.push({
                        endpoint,
                        status: null,
                        kind: 'network',
                    });

                    const hasMoreCandidates = i < endpoints.length - 1;
                    if (hasMoreCandidates) {
                        continue;
                    }
                }
            }

            return lastResponse;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const validationError = validateSuggestionForm();
            if (validationError) {
                showFormError(validationError);
                return;
            }

            // Get form data
            const formData = {
                flightDate: document.getElementById('flightDate').value || 'Not specified',
                flightNumber: document.getElementById('flightNumber').value,
                callsign: document.getElementById('callsign').value,
                aircraft: document.getElementById('aircraft').value,
                departure: document.getElementById('departure').value,
                arrival: document.getElementById('arrival').value,
                route: document.getElementById('route').value,
                flightRadarLink: document.getElementById('flightRadarLink').value || 'Not provided',
                flightTime: document.getElementById('flightTime').value,
                flightLength: document.getElementById('flightLength').value,
                name: document.getElementById('name').value,
                twitchHandle: document.getElementById('twitchHandle').value || 'Not provided',
                timestamp: new Date().toISOString()
            };

            const siteKey = getTurnstileSiteKey();
            if (siteKey) {
                formData.turnstileToken = turnstileToken;
            }

            try {
                // Send to the server-side proxy (Cloudflare Worker recommended) to avoid exposing the Discord webhook.
                // Preferred route: /api/suggestions. If unavailable on this host, fallback tries /api/suggestions.php.
                const response = await postSuggestion(formData);

                if (response.ok) {
                    localStorage.setItem('fwj-suggestions-last-submit', String(Date.now()));
                    // Show success message
                    successMessage.style.display = 'block';
                    errorMessage.style.display = 'none';
                    form.reset();

                    if (turnstileWidgetId !== null && window.turnstile) {
                        try {
                            window.turnstile.reset(turnstileWidgetId);
                        } catch {
                            // ignore
                        }
                        turnstileToken = '';
                    }

                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 5000);
                } else {
                    let details = '‚úó Oops! Something went wrong. Please try again.';
                    const saw405 = lastSuggestionSubmitDiagnostics.some((d) => d && d.kind === 'http' && d.status === 405);
                    const saw404 = lastSuggestionSubmitDiagnostics.some((d) => d && d.kind === 'http' && d.status === 404);
                    const sawNetwork = lastSuggestionSubmitDiagnostics.some((d) => d && d.kind === 'network');

                    try {
                        const data = await response.json();
                        if (data && typeof data.error === 'string' && data.error.trim()) {
                            details = `‚úó ${data.error.trim()}`;
                        } else if (saw405 && sawNetwork) {
                            details = '‚úó Suggestions API is misconfigured (POST blocked and fallback host unreachable).';
                        } else if (saw405) {
                            details = '‚úó Suggestions API is deployed but POST is not enabled on this host.';
                        } else if (saw404) {
                            details = '‚úó Suggestions API endpoint is missing on this host.';
                        } else if (response.status === 404) {
                            details = '‚úó Submission endpoint is not configured yet.';
                        } else if (response.status === 405) {
                            details = '‚úó Submission endpoint exists but is not accepting POST yet.';
                        }
                    } catch {
                        if (saw405 && sawNetwork) {
                            details = '‚úó Suggestions API is misconfigured (POST blocked and fallback host unreachable).';
                        } else if (saw405) {
                            details = '‚úó Suggestions API is deployed but POST is not enabled on this host.';
                        } else if (saw404) {
                            details = '‚úó Suggestions API endpoint is missing on this host.';
                        } else if (response.status === 404) {
                            details = '‚úó Submission endpoint is not configured yet.';
                        } else if (response.status === 405) {
                            details = '‚úó Submission endpoint exists but is not accepting POST yet.';
                        }
                    }
                    throw new Error(details);
                }
            } catch (error) {
                console.error('Error:', error);
                showFormError(error && error.message ? error.message : '‚úó Oops! Something went wrong. Please try again.');

                // Hide error message after 5 seconds
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        });

        // Initialize optional anti-bot verification (no-op unless configured)
        initTurnstileIfConfigured();
    </script>

    <!-- Disclaimer Notice -->
    <div style="background: rgba(102, 187, 106, 0.06); border-top: 1px solid rgba(102, 187, 106, 0.2); padding: 1.5rem 2rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
        <p><strong>Disclaimer:</strong> This website is for entertainment purposes only. Flight simulation streams are not real aviation training. Please read our <a href="privacy.html" style="color: var(--primary); text-decoration: none; font-weight: 600;">Privacy Policy</a> and <a href="terms.html" style="color: var(--primary); text-decoration: none; font-weight: 600;">Terms of Service</a> for complete information.</p>
    </div>

    <!-- Footer -->
    <footer class="footer" style="margin-top: 3rem;">
        <div class="footer-content">
            <p>&copy; 2026 Flying With Joel. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy.html">Privacy Policy</a>
                <a href="terms.html">Terms of Service</a>
                <a href="cookies.html">Cookie Policy</a>
                <a href="#" id="cookie-settings-link">Cookie Settings</a>
                <a href="security.html">Security & Hosting</a>
            </div>
        </div>
    </footer>

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent-banner" class="cookie-consent-banner">
        <div class="cookie-consent-content">
                <p>We use local storage (localStorage) to remember your choices (such as your consent preference for optional third-party embeds/resources). Optional embeds/resources only load after you opt in. If you submit this form and anti-spam protection is enabled, Cloudflare Turnstile may load for security. <a href="privacy.html">Learn more about our privacy practices</a>.</p>
        </div>
        <div class="cookie-consent-buttons">
            <button id="cookie-accept-btn" class="cookie-consent-btn accept">Accept</button>
            <button id="cookie-reject-btn" class="cookie-consent-btn decline">Decline</button>
        </div>
    </div>

    <script src="../assets/js/main.js"></script>
</body>
</html>
